<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממיר מטבעות בזמן אמת</title>
    <!-- Loading Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Rubik', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Removing number input arrows for a cleaner look */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <div id="loader" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
        <div class="spinner w-12 h-12 border-4 border-blue-500 rounded-full"></div>
        <p class="mt-4 text-lg text-gray-700 dark:text-gray-300">טוען שערי חליפין...</p>
    </div>

    <div class="container mx-auto p-4 max-w-lg mt-10">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-2">ממיר מטבעות</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">שערי חליפין מעודכנים בזמן אמת</p>

            <!-- Amount Input -->
            <div class="mb-4">
                <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">סכום</label>
                <input type="number" id="amount" value="100" class="w-full p-3 text-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg border-2 border-transparent focus:border-blue-500 focus:ring-0 outline-none transition">
            </div>

            <!-- Currency Selectors -->
            <div class="flex items-center justify-between space-x-2 rtl:space-x-reverse">
                <!-- From Currency -->
                <div class="w-full">
                    <label for="fromCurrency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ממטבע</label>
                    <select id="fromCurrency" class="w-full p-3 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg border-2 border-transparent focus:border-blue-500 focus:ring-0 outline-none transition"></select>
                </div>

                <!-- Swap Button -->
                <div class="pt-6">
                    <button id="swapBtn" title="החלף מטבעות" class="p-3 bg-gray-200 dark:bg-gray-600 hover:bg-blue-500 hover:text-white text-gray-600 dark:text-gray-300 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </button>
                </div>

                <!-- To Currency -->
                <div class="w-full">
                    <label for="toCurrency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">למטבע</label>
                    <select id="toCurrency" class="w-full p-3 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg border-2 border-transparent focus:border-blue-500 focus:ring-0 outline-none transition"></select>
                </div>
            </div>

            <!-- Result Display -->
            <div class="mt-8 text-center">
                <p id="rateInfo" class="text-sm text-gray-500 dark:text-gray-400 mb-2 h-5"></p>
                <div id="result" class="text-4xl font-bold text-blue-600 dark:text-blue-400 break-words"></div>
                 <p id="error" class="text-red-500 mt-2 h-5"></p>
            </div>
            
            <div class="text-center mt-6 text-xs text-gray-400 dark:text-gray-500">
                <p>השערים מסופקים על ידי <a href="https://exchangerate.host" target="_blank" class="hover:underline">exchangerate.host</a></p>
                <p id="lastUpdated"></p>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const amountInput = document.getElementById('amount');
        const fromSelect = document.getElementById('fromCurrency');
        const toSelect = document.getElementById('toCurrency');
        const swapBtn = document.getElementById('swapBtn');
        const resultDiv = document.getElementById('result');
        const rateInfoDiv = document.getElementById('rateInfo');
        const errorDiv = document.getElementById('error');
        const loader = document.getElementById('loader');
        const lastUpdatedDiv = document.getElementById('lastUpdated');

        // Global state
        let rates = {};
        let symbols = {};
        const API_BASE_URL = 'https://api.exchangerate.host';

        /**
         * Fetches currency symbols and latest rates, then initializes the app.
         */
        async function initializeApp() {
            try {
                // Fetch symbols and rates in parallel for faster loading
                const [symbolsRes, ratesRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/symbols`),
                    fetch(`${API_BASE_URL}/latest?base=USD`) // Using USD as a stable base
                ]);

                if (!symbolsRes.ok || !ratesRes.ok) {
                    throw new Error('שגיאה בטעינת הנתונים מהשרת.');
                }

                const symbolsData = await symbolsRes.json();
                const ratesData = await ratesRes.json();

                if (!symbolsData.success || !ratesData.success) {
                    throw new Error('תשובת ה-API אינה תקינה.');
                }

                symbols = symbolsData.symbols;
                rates = ratesData.rates;
                
                // Add base currency to rates object
                rates['USD'] = 1;

                populateCurrencies();
                setupEventListeners();
                updateConversion();
                
                const updateDate = new Date(ratesData.date);
                lastUpdatedDiv.textContent = `עודכן לאחרונה: ${updateDate.toLocaleString('he-IL')}`;

                // Hide loader after a short delay to prevent flashing
                setTimeout(() => {
                    loader.style.opacity = '0';
                    loader.addEventListener('transitionend', () => loader.style.display = 'none');
                }, 300);

            } catch (err) {
                console.error("Initialization Error:", err);
                loader.innerHTML = `<p class="text-lg text-red-500">${err.message}<br>אנא נסה לרענן את הדף.</p>`;
            }
        }

        /**
         * Populates the currency select dropdowns with options.
         */
        function populateCurrencies() {
            const fragment = document.createDocumentFragment();
            const sortedSymbols = Object.keys(symbols).sort();

            for (const code of sortedSymbols) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${symbols[code].description} (${code})`;
                fragment.appendChild(option);
            }

            fromSelect.appendChild(fragment.cloneNode(true));
            toSelect.appendChild(fragment);

            // Set default values
            fromSelect.value = 'USD';
            toSelect.value = 'ILS';
        }

        /**
         * Sets up all necessary event listeners.
         */
        function setupEventListeners() {
            amountInput.addEventListener('input', updateConversion);
            fromSelect.addEventListener('change', updateConversion);
            toSelect.addEventListener('change', updateConversion);
            swapBtn.addEventListener('click', handleSwap);
        }

        /**
         * Handles the currency swap logic.
         */
        function handleSwap() {
            const temp = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = temp;
            updateConversion();
        }

        /**
         * Performs the currency conversion and updates the UI.
         */
        function updateConversion() {
            const amount = parseFloat(amountInput.value);
            const fromCurrency = fromSelect.value;
            const toCurrency = toSelect.value;

            errorDiv.textContent = ''; // Clear previous errors

            if (isNaN(amount) || amount < 0) {
                resultDiv.textContent = '';
                rateInfoDiv.textContent = '';
                if (amountInput.value !== '') {
                   errorDiv.textContent = 'נא להזין סכום חיובי תקין.';
                }
                return;
            }

            if (!rates[fromCurrency] || !rates[toCurrency]) {
                errorDiv.textContent = 'שער חליפין לא זמין עבור המטבע שנבחר.';
                return;
            }

            // Perform conversion using USD as a base
            const amountInUSD = amount / rates[fromCurrency];
            const convertedAmount = amountInUSD * rates[toCurrency];
            
            // Calculate the single unit exchange rate for display
            const singleUnitRate = (1 / rates[fromCurrency]) * rates[toCurrency];

            // Display results
            const formattedAmount = amount.toLocaleString('he-IL');
            const formattedResult = convertedAmount.toLocaleString('he-IL', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            });

            resultDiv.innerHTML = `${formattedResult} <span class="text-2xl text-gray-500 dark:text-gray-400">${toCurrency}</span>`;
            rateInfoDiv.textContent = `1 ${fromCurrency} = ${singleUnitRate.toFixed(4)} ${toCurrency}`;
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>