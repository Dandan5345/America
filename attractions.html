<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¦×™××ª ×›×ª×•×‘×ª ×•×—×™×©×•×‘ ××¨×—×§</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ×”×’×“×¨×ª ×’×•×‘×” ×œ××¤×” ×©×ª××œ× ××ª ×›×œ ×”××¡×š */
        #map {
            height: 100vh;
            width: 100vw;
        }
        /* ×¢×™×¦×•×‘ ××•×ª×× ×œ×©×¤×” ×”×¢×‘×¨×™×ª */
        body {
            font-family: 'Arial', sans-serif;
        }
        .leaflet-control-container .leaflet-routing-container {
            display: none; /* ××¡×ª×™×¨ ××ª ×”×•×¨××•×ª ×”× ×™×•×•×˜ ×©×œ ×”×ª×•×¡×£, ×× ×—× ×• ×¦×¨×™×›×™× ×¨×§ ××ª ×”×—×™×©×•×‘ */
        }
    </style>
</head>
<body class="relative">

    <!-- ××œ×× ×˜ ×”××¤×” -->
    <div id="map"></div>

    <!-- ×¤×× ×œ ×©×œ×™×˜×” ×¢×œ×™×•×Ÿ -->
    <div id="controls" class="absolute top-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[1000] w-full max-w-sm">
        <h1 class="text-xl font-bold mb-2 text-gray-800">×××ª×¨ ×›×ª×•×‘×•×ª</h1>
        <div class="flex flex-col space-y-3">
            <input type="text" id="addressInput" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª ×œ×—×™×¤×•×©..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex space-x-2 rtl:space-x-reverse">
                <button id="searchBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    ××¦×
                </button>
                <button id="locationBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    ×”×¤×¢×œ ××™×§×•× × ×•×›×—×™
                </button>
            </div>
        </div>
    </div>

    <!-- ×¤×× ×œ ×ª×•×¦××•×ª ×ª×—×ª×•×Ÿ -->
    <div id="resultsPanel" class="absolute bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[1000] hidden">
        <h2 class="text-lg font-bold mb-2 text-gray-700">××¨×—×§×™× ××”××™×§×•× ×©×œ×š:</h2>
        <div id="resultsContent" class="space-y-2 text-gray-600">
            <!-- ×”×ª×•×¦××•×ª ×™×•×¦×’×• ×›××Ÿ -->
        </div>
    </div>
    
    <!-- ×”×•×“×¢×•×ª ×œ××©×ª××© -->
    <div id="messageBox" class="absolute top-20 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md z-[1001] hidden" role="alert">
        <strong class="font-bold">×©×’×™××”:</strong>
        <span class="block sm:inline" id="messageText"></span>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let map;
        let destinationMarker = null;
        let userLocation = null;
        let destinationLocation = null;

        // --- ××ª×—×•×œ ×”××¤×” ---
        document.addEventListener('DOMContentLoaded', function () {
            // ××ª×—×•×œ ×”××¤×” ×¢× ××¨×›×•×– ×¢×œ ×™×©×¨××œ
            map = L.map('map').setView([31.7683, 35.2137], 8);

            // ×”×•×¡×¤×ª ×©×›×‘×ª ××¤×” ×©×œ OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // --- ×”×•×¡×¤×ª Event Listeners ×œ×›×¤×ª×•×¨×™× ---
            document.getElementById('searchBtn').addEventListener('click', searchAddress);
            document.getElementById('locationBtn').addEventListener('click', enableLocation);
            
            // ×××¤×©×¨ ×—×™×¤×•×© ×’× ×‘×××¦×¢×•×ª ×”×§×©×ª Enter
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
        });

        // --- ×¤×•× ×§×¦×™×•×ª ---

        /**
         * ××¦×™×’ ×”×•×“×¢×” ×œ××©×ª××©
         * @param {string} text - ×”×˜×§×¡×˜ ×œ×”×¦×’×”
         * @param {boolean} isError - ×”×× ×”×”×•×“×¢×” ×”×™× ×”×•×“×¢×ª ×©×’×™××”
         */
        function showMessage(text, isError = true) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            messageBox.className = `absolute top-20 right-4 p-4 rounded-md z-[1001] ${isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-blue-100 border border-blue-400 text-blue-700'}`;
            messageBox.classList.remove('hidden');

            // ×”×¡×ª×¨×ª ×”×”×•×“×¢×” ×œ××—×¨ 5 ×©× ×™×•×ª
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * ××—×¤×© ××ª ×”×›×ª×•×‘×ª ×©×”×•×–× ×” ×•××¦×™×’ ××•×ª×” ×¢×œ ×”××¤×”
         */
        async function searchAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                showMessage('×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ×œ×—×™×¤×•×©.');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '××—×¤×©...';

            // ×©×™××•×© ×‘-Nominatim API ×©×œ OpenStreetMap ×œ×—×™×¤×•×© ×›×ª×•×‘×ª
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=il&addressdetails=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    destinationLocation = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };

                    // ×”×¡×¨×ª ×¡×™××•×Ÿ ×§×•×“× ×× ×§×™×™×
                    if (destinationMarker) {
                        map.removeLayer(destinationMarker);
                    }

                    // ×”×•×¡×¤×ª ×¡×™××•×Ÿ ×—×“×© ×•××¨×›×•×– ×”××¤×”
                    destinationMarker = L.marker([destinationLocation.lat, destinationLocation.lng]).addTo(map);
                    map.setView([destinationLocation.lat, destinationLocation.lng], 15);
                    destinationMarker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                    
                    // ×× ×”××™×§×•× ×”× ×•×›×—×™ ×™×“×•×¢, ×—×©×‘ ××¨×—×§×™×
                    if (userLocation) {
                        calculateAndDisplayDistances();
                    }

                } else {
                    showMessage('×”×›×ª×•×‘×ª ×œ× × ××¦××”. × ×¡×”/×™ ×©×•×‘.');
                    destinationLocation = null;
                }
            } catch (error) {
                console.error('Error fetching address:', error);
                showMessage('××™×¨×¢×” ×©×’×™××” ×‘××”×œ×š ×”×—×™×¤×•×©.');
                destinationLocation = null;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg> ××¦×`;
            }
        }

        /**
         * ××‘×§×© ×”×¨×©××ª ××™×§×•× ××”××©×ª××©
         */
        function enableLocation() {
            if (!navigator.geolocation) {
                showMessage('×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.');
                return;
            }
            
            const locationBtn = document.getElementById('locationBtn');
            locationBtn.disabled = true;
            locationBtn.innerHTML = '××××ª ××™×§×•×...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // ×”×•×¡×¤×ª ×¡×™××•×Ÿ ×œ××™×§×•× ×”××©×ª××©
                    L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup('<b>×”××™×§×•× ×©×œ×š</b>');

                    showMessage('×”××™×§×•× ×”× ×•×›×—×™ ×–×•×”×” ×‘×”×¦×œ×—×”!', false);
                    locationBtn.innerHTML = '××™×§×•× ×”×•×¤×¢×œ';
                    
                    // ×× ×”×™×¢×“ ×™×“×•×¢, ×—×©×‘ ××¨×—×§×™×
                    if (destinationLocation) {
                        calculateAndDisplayDistances();
                    }
                },
                (error) => {
                    let errorMessage = '××™×¨×¢×” ×©×’×™××” ×‘×§×‘×œ×ª ×”××™×§×•×.';
                    if (error.code === 1) {
                        errorMessage = '×”×’×™×©×” ×œ××™×§×•× × ×“×—×ª×”. ×™×© ×œ××¤×©×¨ ×’×™×©×” ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ.';
                    }
                    showMessage(errorMessage);
                    console.error('Geolocation error:', error);
                    locationBtn.disabled = false;
                    locationBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ×”×¤×¢×œ ××™×§×•× × ×•×›×—×™`;
                }
            );
        }

        /**
         * ××—×©×‘ ×•××¦×™×’ ××ª ××¨×—×§×™ ×”×”×œ×™×›×” ×•×”× ×¡×™×¢×”
         */
        async function calculateAndDisplayDistances() {
            if (!userLocation || !destinationLocation) {
                return;
            }

            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '<p>××—×©×‘ ××¨×—×§×™×...</p>';
            resultsPanel.classList.remove('hidden');

            const userLngLat = `${userLocation.lng},${userLocation.lat}`;
            const destLngLat = `${destinationLocation.lng},${destinationLocation.lat}`;

            try {
                // ×©×™××•×© ×‘-OSRM API, ×”×× ×•×¢ ×©×××—×•×¨×™ OpenStreetMap Routing
                const drivingUrl = `https://router.project-osrm.org/route/v1/driving/${userLngLat};${destLngLat}?overview=false`;
                const walkingUrl = `https://router.project-osrm.org/route/v1/foot/${userLngLat};${destLngLat}?overview=false`;

                const [drivingResponse, walkingResponse] = await Promise.all([
                    fetch(drivingUrl),
                    fetch(walkingUrl)
                ]);

                const drivingData = await drivingResponse.json();
                const walkingData = await walkingResponse.json();

                let resultsHTML = '';

                if (drivingData.code === 'Ok' && drivingData.routes && drivingData.routes.length > 0) {
                    const distance = drivingData.routes[0].distance; // ×‘××˜×¨×™×
                    resultsHTML += `<p>ğŸš— <b>××¨×—×§ × ×¡×™×¢×”:</b> ${formatDistance(distance)}</p>`;
                } else {
                    resultsHTML += `<p>ğŸš— <b>××¨×—×§ × ×¡×™×¢×”:</b> ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×—×©×‘.</p>`;
                }

                if (walkingData.code === 'Ok' && walkingData.routes && walkingData.routes.length > 0) {
                    const distance = walkingData.routes[0].distance; // ×‘××˜×¨×™×
                    resultsHTML += `<p>ğŸš¶â€â™‚ï¸ <b>××¨×—×§ ×”×œ×™×›×”:</b> ${formatDistance(distance)}</p>`;
                } else {
                    resultsHTML += `<p>ğŸš¶â€â™‚ï¸ <b>××¨×—×§ ×”×œ×™×›×”:</b> ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×—×©×‘.</p>`;
                }
                
                resultsContent.innerHTML = resultsHTML;

            } catch (error) {
                console.error('Error calculating distances:', error);
                resultsContent.innerHTML = '<p class="text-red-500">×©×’×™××” ×‘×—×™×©×•×‘ ×”××¨×—×§×™×.</p>';
            }
        }
        
        /**
         * ×××™×¨ ××¨×—×§ ×‘××˜×¨×™× ×œ××—×¨×•×–×ª ×§×¨×™××” (×§"× ××• ××˜×¨)
         * @param {number} meters - ×”××¨×—×§ ×‘××˜×¨×™×
         * @returns {string} - ××—×¨×•×–×ª ×”××¨×—×§ ×”××¢×•×¦×‘×ª
         */
        function formatDistance(meters) {
            if (meters > 1000) {
                return `${(meters / 1000).toFixed(2)} ×§"×`;
            }
            return `${Math.round(meters)} ××˜×¨`;
        }

    </script>
</body>
</html>