<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מציאת כתובת וחישוב מרחק</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* הגדרת גובה למפה שתמלא את כל המסך */
        #map {
            height: 100vh;
            width: 100vw;
        }
        /* עיצוב מותאם לשפה העברית */
        body {
            font-family: 'Arial', sans-serif;
        }
        .leaflet-control-container .leaflet-routing-container {
            display: none; /* מסתיר את הוראות הניווט של התוסף, אנחנו צריכים רק את החישוב */
        }
    </style>
</head>
<body class="relative">

    <!-- אלמנט המפה -->
    <div id="map"></div>

    <!-- פאנל שליטה עליון -->
    <div id="controls" class="absolute top-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[1000] w-full max-w-sm">
        <h1 class="text-xl font-bold mb-2 text-gray-800">מאתר כתובות</h1>
        <div class="flex flex-col space-y-3">
            <input type="text" id="addressInput" placeholder="הזן כתובת לחיפוש..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex space-x-2 rtl:space-x-reverse">
                <button id="searchBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    מצא
                </button>
                <button id="locationBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    הפעל מיקום נוכחי
                </button>
            </div>
        </div>
    </div>

    <!-- פאנל תוצאות תחתון -->
    <div id="resultsPanel" class="absolute bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg z-[1000] hidden">
        <h2 class="text-lg font-bold mb-2 text-gray-700">מרחקים מהמיקום שלך:</h2>
        <div id="resultsContent" class="space-y-2 text-gray-600">
            <!-- התוצאות יוצגו כאן -->
        </div>
    </div>
    
    <!-- הודעות למשתמש -->
    <div id="messageBox" class="absolute top-20 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md z-[1001] hidden" role="alert">
        <strong class="font-bold">שגיאה:</strong>
        <span class="block sm:inline" id="messageText"></span>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- משתנים גלובליים ---
        let map;
        let destinationMarker = null;
        let userLocation = null;
        let destinationLocation = null;

        // --- אתחול המפה ---
        document.addEventListener('DOMContentLoaded', function () {
            // אתחול המפה עם מרכוז על ישראל
            map = L.map('map').setView([31.7683, 35.2137], 8);

            // הוספת שכבת מפה של OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // --- הוספת Event Listeners לכפתורים ---
            document.getElementById('searchBtn').addEventListener('click', searchAddress);
            document.getElementById('locationBtn').addEventListener('click', enableLocation);
            
            // מאפשר חיפוש גם באמצעות הקשת Enter
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
        });

        // --- פונקציות ---

        /**
         * מציג הודעה למשתמש
         * @param {string} text - הטקסט להצגה
         * @param {boolean} isError - האם ההודעה היא הודעת שגיאה
         */
        function showMessage(text, isError = true) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            messageBox.className = `absolute top-20 right-4 p-4 rounded-md z-[1001] ${isError ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-blue-100 border border-blue-400 text-blue-700'}`;
            messageBox.classList.remove('hidden');

            // הסתרת ההודעה לאחר 5 שניות
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * מחפש את הכתובת שהוזנה ומציג אותה על המפה
         */
        async function searchAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                showMessage('יש להזין כתובת לחיפוש.');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = 'מחפש...';

            // שימוש ב-Nominatim API של OpenStreetMap לחיפוש כתובת
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=il&addressdetails=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    destinationLocation = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };

                    // הסרת סימון קודם אם קיים
                    if (destinationMarker) {
                        map.removeLayer(destinationMarker);
                    }

                    // הוספת סימון חדש ומרכוז המפה
                    destinationMarker = L.marker([destinationLocation.lat, destinationLocation.lng]).addTo(map);
                    map.setView([destinationLocation.lat, destinationLocation.lng], 15);
                    destinationMarker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                    
                    // אם המיקום הנוכחי ידוע, חשב מרחקים
                    if (userLocation) {
                        calculateAndDisplayDistances();
                    }

                } else {
                    showMessage('הכתובת לא נמצאה. נסה/י שוב.');
                    destinationLocation = null;
                }
            } catch (error) {
                console.error('Error fetching address:', error);
                showMessage('אירעה שגיאה במהלך החיפוש.');
                destinationLocation = null;
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg> מצא`;
            }
        }

        /**
         * מבקש הרשאת מיקום מהמשתמש
         */
        function enableLocation() {
            if (!navigator.geolocation) {
                showMessage('שירותי מיקום אינם נתמכים בדפדפן זה.');
                return;
            }
            
            const locationBtn = document.getElementById('locationBtn');
            locationBtn.disabled = true;
            locationBtn.innerHTML = 'מאמת מיקום...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // הוספת סימון למיקום המשתמש
                    L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map).bindPopup('<b>המיקום שלך</b>');

                    showMessage('המיקום הנוכחי זוהה בהצלחה!', false);
                    locationBtn.innerHTML = 'מיקום הופעל';
                    
                    // אם היעד ידוע, חשב מרחקים
                    if (destinationLocation) {
                        calculateAndDisplayDistances();
                    }
                },
                (error) => {
                    let errorMessage = 'אירעה שגיאה בקבלת המיקום.';
                    if (error.code === 1) {
                        errorMessage = 'הגישה למיקום נדחתה. יש לאפשר גישה בהגדרות הדפדפן.';
                    }
                    showMessage(errorMessage);
                    console.error('Geolocation error:', error);
                    locationBtn.disabled = false;
                    locationBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> הפעל מיקום נוכחי`;
                }
            );
        }

        /**
         * מחשב ומציג את מרחקי ההליכה והנסיעה
         */
        async function calculateAndDisplayDistances() {
            if (!userLocation || !destinationLocation) {
                return;
            }

            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '<p>מחשב מרחקים...</p>';
            resultsPanel.classList.remove('hidden');

            const userLngLat = `${userLocation.lng},${userLocation.lat}`;
            const destLngLat = `${destinationLocation.lng},${destinationLocation.lat}`;

            try {
                // שימוש ב-OSRM API, המנוע שמאחורי OpenStreetMap Routing
                const drivingUrl = `https://router.project-osrm.org/route/v1/driving/${userLngLat};${destLngLat}?overview=false`;
                const walkingUrl = `https://router.project-osrm.org/route/v1/foot/${userLngLat};${destLngLat}?overview=false`;

                const [drivingResponse, walkingResponse] = await Promise.all([
                    fetch(drivingUrl),
                    fetch(walkingUrl)
                ]);

                const drivingData = await drivingResponse.json();
                const walkingData = await walkingResponse.json();

                let resultsHTML = '';

                if (drivingData.code === 'Ok' && drivingData.routes && drivingData.routes.length > 0) {
                    const distance = drivingData.routes[0].distance; // במטרים
                    resultsHTML += `<p>🚗 <b>מרחק נסיעה:</b> ${formatDistance(distance)}</p>`;
                } else {
                    resultsHTML += `<p>🚗 <b>מרחק נסיעה:</b> לא ניתן היה לחשב.</p>`;
                }

                if (walkingData.code === 'Ok' && walkingData.routes && walkingData.routes.length > 0) {
                    const distance = walkingData.routes[0].distance; // במטרים
                    resultsHTML += `<p>🚶‍♂️ <b>מרחק הליכה:</b> ${formatDistance(distance)}</p>`;
                } else {
                    resultsHTML += `<p>🚶‍♂️ <b>מרחק הליכה:</b> לא ניתן היה לחשב.</p>`;
                }
                
                resultsContent.innerHTML = resultsHTML;

            } catch (error) {
                console.error('Error calculating distances:', error);
                resultsContent.innerHTML = '<p class="text-red-500">שגיאה בחישוב המרחקים.</p>';
            }
        }
        
        /**
         * ממיר מרחק במטרים למחרוזת קריאה (ק"מ או מטר)
         * @param {number} meters - המרחק במטרים
         * @returns {string} - מחרוזת המרחק המעוצבת
         */
        function formatDistance(meters) {
            if (meters > 1000) {
                return `${(meters / 1000).toFixed(2)} ק"מ`;
            }
            return `${Math.round(meters)} מטר`;
        }

    </script>
</body>
</html>