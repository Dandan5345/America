<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¡×¢ ×—×œ×•××•×ª ğŸ—½ ×¨×©×™××•×ª ×•×¦'×§-×œ×™×¡×˜×™×</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .submenu.open { max-height: 1200px; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .chevron-icon { transition: transform 0.3s ease-out; }
        details[open] > summary .chevron-icon { transform: rotate(180deg); }

        .checklist-item input:checked + label { text-decoration: line-through; color: #9ca3af; }
        .checklist-item input:checked + label .fa-circle { display: none; }
        .checklist-item input:checked + label .fa-check-circle { display: inline-block; }
        .fa-check-circle { display: none; }
        
        .priority-3 { border-right: 4px solid #ef4444; }
        .priority-2 { border-right: 4px solid #f97316; }
        .priority-1 { border-right: 4px solid #eab308; }

        /* Modal styles */
        .modal-step { display: none; }
        .modal-step.active { display: block; }

        /* Loading Spinner */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f1f5f9; display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        #main-content.loaded { visibility: visible; opacity: 1; }
        #main-content { visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Spinner -->
    <div id="loader">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
    </div>

    <!-- Sidebar (Full Navigation Menu) -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
            <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢</h2>
            <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>

    <!-- Main Content -->
    <div id="main-content">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a href="index.html" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×‘×™×ª"><i class="fas fa-home fa-lg"></i></a>
                        <h1 class="text-xl font-bold text-slate-800">×¨×©×™××•×ª ×•×¦'×§-×œ×™×¡×˜×™×</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="auth-container" class="flex items-center"></div>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-10">
                    <div class="text-right">
                        <h2 class="text-4xl font-extrabold text-slate-800">× ×™×”×•×œ ×¨×©×™××•×ª</h2>
                        <p class="mt-2 text-lg text-slate-600">×›×œ ××” ×©×¦×¨×™×š ×œ××¨×•×– ×•×œ×–×›×•×¨, ××¡×•× ×›×¨×Ÿ ×‘×–××Ÿ ×××ª.</p>
                    </div>
                    <button id="add-checklist-btn" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i> ×”×•×¡×£ ×¨×©×™××”
                    </button>
                </div>

                <div id="checklists-container" class="space-y-6">
                    <!-- Checklists from Firestore will be rendered here -->
                </div>
            </div>
        </main>
    </div>
    
    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

    <!-- Add/Edit Checklist Modal -->
    <div id="checklist-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <!-- Step 0: Name -->
                <div id="step-0" class="modal-step">
                    <label for="checklist-name" class="block text-sm font-bold text-slate-700 mb-2">×©× ×”×¨×©×™××” (×œ×“×•×’××”: "××¨×™×–×” ×œ×˜×™×¡×” ×œ× ×™×• ×™×•×¨×§")</label>
                    <input type="text" id="checklist-name" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="×©× ×™×™×—×•×“×™ ×œ×¨×©×™××”">
                </div>
                <!-- Step 1: Type -->
                <div id="step-1" class="modal-step">
                    <label class="block text-sm font-bold text-slate-700 mb-2">×©××œ×” 1: ×‘×—×¨ ×¡×•×’ ×¨×©×™××”</label>
                    <select id="checklist-type" class="w-full p-2 border border-slate-300 rounded-lg">
                        <option value="">-- ×‘×—×¨ --</option>
                        <option value="×œ×¤× ×™ ×”×˜×™×•×œ">×œ×¤× ×™ ×”×˜×™×•×œ</option>
                        <option value="×œ×¤× ×™ ×™×¢×“">×œ×¤× ×™ ×™×¢×“</option>
                        <option value="×œ×¤× ×™ ××¢×‘×¨">×œ×¤× ×™ ××¢×‘×¨</option>
                        <option value="××—×¨">××—×¨</option>
                    </select>
                    <input type="text" id="checklist-type-other" class="w-full p-2 border border-slate-300 rounded-lg mt-2 hidden" placeholder="×”×§×œ×“ ×©× ×œ×¡×•×’ ×”×¨×©×™××”">
                </div>
                <!-- Step 2: SubType / Destination -->
                <div id="step-2" class="modal-step"></div>
                <!-- Step 3: Tertiary Type -->
                <div id="step-3" class="modal-step"></div>
                <!-- Step 4: Items Table -->
                <div id="step-4" class="modal-step">
                    <h4 class="text-lg font-bold text-slate-700 mb-3">×”×•×¡×¤×ª ×¤×¨×™×˜×™× ×œ×¨×©×™××”</h4>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <input type="text" id="item-text" placeholder="×©× ×”×¤×¨×™×˜" class="md:col-span-2 p-2 border rounded-md">
                            <input type="number" id="item-quantity" placeholder="×›××•×ª" value="1" class="p-2 border rounded-md">
                            <input type="text" id="item-description" placeholder="×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)" class="p-2 border rounded-md">
                            <select id="item-priority" class="p-2 border rounded-md">
                                <option value="1">×—×©×™×‘×•×ª × ××•×›×”</option>
                                <option value="2">×—×©×™×‘×•×ª ×‘×™× ×•× ×™×ª</option>
                                <option value="3">×—×©×™×‘×•×ª ×’×‘×•×”×”</option>
                            </select>
                        </div>
                        <button id="add-item-btn" class="mt-3 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition w-full">×”×•×¡×£ ×¤×¨×™×˜</button>
                    </div>
                    <div id="items-preview-container" class="mt-4 space-y-2"></div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-between items-center">
                <div>
                    <button id="modal-back-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition">××—×•×¨×”</button>
                </div>
                <div id="modal-steps-indicator" class="text-sm text-slate-500"></div>
                <div>
                    <button id="modal-next-btn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
                    <button id="modal-finish-btn" class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition hidden">×©××•×¨ ×¨×©×™××”</button>
                    <button id="modal-close-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition">×‘×˜×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
            <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§ ××ª ×”×¨×©×™××”?</h3>
            <p id="delete-modal-text" class="text-slate-600 mb-6">×¤×¢×•×œ×” ×–×• ×”×™× ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
            <div class="flex justify-center gap-4">
                <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
                <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuhPaw4P-rLeb1Xzou2COUE1O0hX3z44w",
            authDomain: "america1tour.firebaseapp.com",
            projectId: "america1tour",
            storageBucket: "america1tour.firebasestorage.app",
            messagingSenderId: "70515728009",
            appId: "1:70515728009:web:aded0696b4f72c910b7058",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const checklistsCollection = collection(db, 'checklists');

        // --- Start of Application Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            
            // Data for the entire site
            const siteData = {
                menu: [
                    { id: 'israel', page: 'israel.html', title: 'ğŸ‡®ğŸ‡± ×™×•× ×”×™×¦×™××”', emoji: 'ğŸ‡®ğŸ‡±', days: [ { id: 'day-22-12', label: '22/12' } ] },
                    { id: 'new-york', page: 'new-york.html', title: 'ğŸ—½ × ×™×•-×™×•×¨×§', emoji: 'ğŸ—½', days: [ { id: 'day-23-12', label: '23/12' }, { id: 'day-24-12', label: '24/12' }, { id: 'day-25-12', label: '25/12' }, { id: 'day-26-12', label: '26/12' }, { id: 'day-27-12', label: '27/12' }, { id: 'day-28-12', label: '28/12' }, { id: 'day-29-12', label: '29/12' }, { id: 'day-30-12', label: '30/12' }, { id: 'day-31-12', label: '31/12' }, { id: 'day-01-01', label: '01/01' } ]},
                    { id: 'niagara', page: 'niagara.html', title: 'â„ï¸ ×§× ×“×”', emoji: 'ğŸ‡¨ğŸ‡¦', days: [ { id: 'day-01-01', label: '01/01' }, { id: 'day-02-01', label: '02/01' }, { id: 'day-03-01', label: '03/01' }, { id: 'day-04-01', label: '04/01' } ]},
                    { id: 'dc', page: 'dc.html', title: 'ğŸ›ï¸ ×•×•×©×™× ×’×˜×•×Ÿ ×“×™.×¡×™', emoji: 'ğŸ›ï¸', days: [ { id: 'day-04-01', label: '04/01' }, { id: 'day-05-01', label: '05/01' }, { id: 'day-06-01', label: '06/01' }, { id: 'day-07-01', label: '07/01' } ]},
                    { id: 'orlando', page: 'orlando.html', title: 'ğŸ¢ ××•×¨×œ× ×“×•', emoji: 'ğŸ¢', days: [ { id: 'day-07-01', label: '07/01' }, { id: 'day-08-01', label: '08/01' }, { id: 'day-09-01', label: '09/01' }, { id: 'day-10-01', label: '10/01' }, { id: 'day-11-01', label: '11/01' }, { id: 'day-12-01', label: '12/01' } ]},
                    { id: 'miami', page: 'miami.html', title: 'ğŸŒ´ ××™×××™', emoji: 'ğŸŒ´', days: [ { id: 'day-12-01', label: '12/01' }, { id: 'day-13-01', label: '13/01' }, { id: 'day-14-01', label: '14/01' }, { id: 'day-15-01', label: '15/01' }, { id: 'day-16-01', label: '16/01' }, { id: 'day-17-01', label: '17/01' }, { id: 'day-18-01', label: '18/01' } ]},
                    { id: 'punta-cana', page: 'punta-cana.html', title: 'ğŸ¹ ×¤×•× ×˜×”-×§×× ×”', emoji: 'ğŸ¹', days: [ { id: 'day-18-01', label: '18/01' }, { id: 'day-19-01', label: '19/01' }, { id: 'day-20-01', label: '20/01' }, { id: 'day-21-01', label: '21/01' }, { id: 'day-22-01', label: '22/01' } ]},
                    { id: 'arizona', page: 'arizona.html', title: 'ğŸœï¸ ××¨×™×–×•× ×”', emoji: 'ğŸœï¸', days: [ { id: 'day-22-01', label: '22/01' }, { id: 'day-23-01', label: '23/01' }, { id: 'day-24-01', label: '24/01' }, { id: 'day-25-01', label: '25/01' }, { id: 'day-26-01', label: '26/01' }, { id: 'day-27-01', label: '27/01' } ]},
                    { id: 'la', page: 'la.html', title: 'ğŸ¬ ×œ×•×¡ ×× ×’\'×œ×¡', emoji: 'ğŸ¬', days: [ { id: 'day-27-01', label: '27/01' }, { id: 'day-28-01', label: '28/01' }, { id: 'day-29-01', label: '29/01' }, { id: 'day-30-01', label: '30/01' }, { id: 'day-31-01', label: '31/01' }, { id: 'day-01-02', label: '01/02' } ]},
                    { id: 'sf', page: 'sf.html', title: 'ğŸŒ‰ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•', emoji: 'ğŸŒ‰', days: [ { id: 'day-01-02', label: '01/02' }, { id: 'day-02-02', label: '02/02' }, { id: 'day-03-02', label: '03/02' }, { id: 'day-04-02', label: '04/02' }, { id: 'day-05-02', label: '05/02' } ]},
                ],
                destinations: ["× ×™×• ×™×•×¨×§", "××¤×œ×™ ×”× ×™××’×¨×” ×•×§× ×“×”", "×•×•×©×™× ×’×˜×•×Ÿ ×“×™ ×¡×™", "××•×¨×œ× ×“×•", "××™×××™", "×¤×•× ×˜×” ×§×× ×”", "××¨×™×–×•× ×”", "×œ×•×¡ ×× ×’'×œ×¡", "×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•", "×—×–×¨×” ×œ××¨×¥"]
            };

            // DOM Elements
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const overlay = document.getElementById('overlay');
            const mainMenu = document.getElementById('main-menu');
            const authContainer = document.getElementById('auth-container');
            const checklistsContainer = document.getElementById('checklists-container');
            
            // Modal Elements
            const checklistModal = document.getElementById('checklist-modal');
            const addChecklistBtn = document.getElementById('add-checklist-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalBackBtn = document.getElementById('modal-back-btn');
            const modalNextBtn = document.getElementById('modal-next-btn');
            const modalFinishBtn = document.getElementById('modal-finish-btn');
            const modalStepsIndicator = document.getElementById('modal-steps-indicator');
            const modalTitle = document.getElementById('modal-title');
            const allModalSteps = document.querySelectorAll('.modal-step');

            // Delete Modal Elements
            const deleteModal = document.getElementById('delete-modal');
            const deleteModalCancel = document.getElementById('delete-modal-cancel');
            const deleteModalConfirm = document.getElementById('delete-modal-confirm');
            
            // --- Global State ---
            let checklistsData = [];
            let currentModalStep = 0;
            let totalModalSteps = 0;
            let modalItems = [];
            let editingChecklistId = null;

            // --- Main Functions ---
            
            function renderChecklists() {
                if (checklistsData.length === 0) {
                    checklistsContainer.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md">
                        <i class="fas fa-folder-open fa-3x text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-700">××™×Ÿ ×¢×“×™×™×Ÿ ×¨×©×™××•×ª</h3>
                        <p class="text-slate-500">×œ×—×¥ ×¢×œ "×”×•×¡×£ ×¨×©×™××”" ×›×“×™ ×œ×”×ª×—×™×œ.</p>
                    </div>`;
                    return;
                }

                const groupedByType = groupBy(checklistsData, 'type');
                let html = '';

                for (const type in groupedByType) {
                    html += `<details class="bg-white p-4 rounded-2xl shadow-lg" open><summary class="text-2xl font-bold text-slate-700 cursor-pointer flex justify-between items-center"><span>${type}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary><div class="mt-4 pt-4 border-t space-y-4">`;
                    
                    const listsInType = groupedByType[type];
                    // Further grouping logic can be added here based on destination/subType if needed
                    listsInType.forEach(list => {
                        html += renderSingleChecklist(list);
                    });

                    html += `</div></details>`;
                }
                checklistsContainer.innerHTML = html;
            }

            function renderSingleChecklist(list) {
                const sortedItems = list.items.sort((a, b) => b.priority - a.priority);
                let itemsHtml = sortedItems.map((item, index) => `
                    <div class="checklist-item flex items-center justify-between p-2 rounded-md hover:bg-slate-50 ${'priority-' + item.priority}">
                        <div class="flex-grow">
                            <input type="checkbox" id="item-${list.id}-${index}" class="hidden" data-list-id="${list.id}" data-item-index="${index}" ${item.checked ? 'checked' : ''}>
                            <label for="item-${list.id}-${index}" class="flex items-center gap-3 text-lg text-slate-700 cursor-pointer">
                                <i class="far fa-circle text-sky-500"></i>
                                <i class="fas fa-check-circle text-green-500"></i>
                                <div>
                                    <span class="font-semibold">${item.text}</span> <span class="text-sm text-slate-500">(×›××•×ª: ${item.quantity})</span>
                                    ${item.description ? `<p class="text-sm text-slate-500">${item.description}</p>` : ''}
                                </div>
                            </label>
                        </div>
                        <div class="text-xs font-bold text-white px-2 py-1 rounded-full ${item.priority == 3 ? 'bg-red-500' : item.priority == 2 ? 'bg-orange-500' : 'bg-yellow-500'}">
                           ×—×©×™×‘×•×ª ${item.priority}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="text-xl font-bold text-slate-800">${list.name}</h4>
                             <div>
                                <button class="edit-btn p-2 text-slate-500 hover:text-blue-600" data-list-id="${list.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-btn p-2 text-slate-500 hover:text-red-600" data-list-id="${list.id}"><i class="fas fa-trash-alt"></i></button>
                             </div>
                        </div>
                        <div class="space-y-2">${itemsHtml}</div>
                    </div>`;
            }

            // --- Modal Logic ---
            function openModal(checklistToEdit = null) {
                editingChecklistId = checklistToEdit ? checklistToEdit.id : null;
                modalTitle.textContent = checklistToEdit ? '×¢×¨×™×›×ª ×¨×©×™××”' : '×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”';
                
                // Reset form
                document.getElementById('checklist-name').value = checklistToEdit ? checklistToEdit.name : '';
                document.getElementById('checklist-type').value = checklistToEdit ? checklistToEdit.type : '';
                // more reset logic needed for other fields
                modalItems = checklistToEdit ? [...checklistToEdit.items] : [];
                renderModalItems();

                currentModalStep = 0;
                updateModalStep();
                checklistModal.classList.add('flex');
                checklistModal.classList.remove('hidden');
            }

            function closeModal() {
                checklistModal.classList.add('hidden');
                checklistModal.classList.remove('flex');
            }

            function updateModalStep() {
                // Logic to determine total steps based on selections
                const type = document.getElementById('checklist-type').value;
                if (type === '×œ×¤× ×™ ×™×¢×“' || type === '×œ×¤× ×™ ××¢×‘×¨') {
                    totalModalSteps = 4;
                } else if (type === '×œ×¤× ×™ ×”×˜×™×•×œ') {
                    totalModalSteps = 3;
                } else if (type === '××—×¨') {
                    totalModalSteps = 2;
                } else {
                    totalModalSteps = 1;
                }
                
                allModalSteps.forEach(step => step.classList.remove('active'));
                document.getElementById(`step-${currentModalStep}`).classList.add('active');
                
                modalBackBtn.classList.toggle('hidden', currentModalStep === 0);
                modalNextBtn.classList.toggle('hidden', currentModalStep >= totalModalSteps);
                modalFinishBtn.classList.toggle('hidden', currentModalStep < totalModalSteps);
                
                modalStepsIndicator.textContent = `×©×œ×‘ ${currentModalStep + 1} ××ª×•×š ${totalModalSteps + 1}`;
                
                // Dynamic step content generation
                if (currentModalStep === 1) generateStep2();
                if (currentModalStep === 2) generateStep3();
            }

            function generateStep2() {
                const type = document.getElementById('checklist-type').value;
                const container = document.getElementById('step-2');
                let html = '';
                if (type === '×œ×¤× ×™ ×”×˜×™×•×œ') {
                    html = `<label class="block text-sm font-bold text-slate-700 mb-2">×©××œ×” 2: ×‘×—×¨ × ×•×©×</label>
                            <select id="checklist-subtype" class="w-full p-2 border rounded-lg">
                                <option>×¨×©×™××ª ×‘×’×“×™× ×œ×‘×Ÿ</option>
                                <option>×¨×©×™××ª ×‘×’×“×™× ×œ×‘×ª</option>
                                <option>××¡××›×™× ×•××™×©×•×¨×™×</option>
                                <option>×”×–×× ×•×ª</option>
                                <option>×§× ×™×•×ª</option>
                                <option>××•×¦×¨×™× ×—×©×•×‘×™×</option>
                                <option value="××—×¨">××—×¨</option>
                            </select>
                            <input type="text" id="checklist-subtype-other" class="w-full p-2 border rounded-lg mt-2 hidden" placeholder="×”×§×œ×“ ×©× ×œ× ×•×©×">`;
                } else if (type === '×œ×¤× ×™ ×™×¢×“' || type === '×œ×¤× ×™ ××¢×‘×¨') {
                    const options = siteData.destinations.map(d => `<option>${d}</option>`).join('');
                    html = `<label class="block text-sm font-bold text-slate-700 mb-2">×©××œ×” 2: ×‘×—×¨ ×™×¢×“</label>
                            <select id="checklist-destination" class="w-full p-2 border rounded-lg">${options}</select>`;
                } else {
                    html = ''; // No step 2 for 'other'
                }
                container.innerHTML = html;
            }
            
            function generateStep3() {
                // Similar logic for step 3 based on previous choices
                const container = document.getElementById('step-3');
                container.innerHTML = ''; // Clear previous content
                const type = document.getElementById('checklist-type').value;
                let html = '';
                if (type === '×œ×¤× ×™ ×™×¢×“') {
                    html = `<label class="block text-sm font-bold text-slate-700 mb-2">×©××œ×” 3: ×‘×—×¨ × ×•×©× ×œ×™×¢×“</label>
                            <select id="checklist-subtype" class="w-full p-2 border rounded-lg">
                                <option>×‘×’×“×™× ×œ×‘×Ÿ</option>
                                <option>×‘×’×“×™× ×œ×‘×ª</option>
                                <option>××¡××›×™× ×œ×™×¢×“</option>
                                <option>×¦×™×•×“ × ×“×¨×©</option>
                                <option value="××—×¨">××—×¨</option>
                            </select>
                            <input type="text" id="checklist-subtype-other" class="w-full p-2 border rounded-lg mt-2 hidden" placeholder="×”×§×œ×“ ×©× ×œ× ×•×©×">`;
                } else if (type === '×œ×¤× ×™ ××¢×‘×¨') {
                    html = `<label class="block text-sm font-bold text-slate-700 mb-2">×©××œ×” 3: ×‘×—×¨ × ×•×©× ×œ××¢×‘×¨</label>
                            <select id="checklist-subtype" class="w-full p-2 border rounded-lg">
                                <option>××™×©×•×¨×™× ×•××¡××›×™×</option>
                                <option>×§× ×™×•×ª</option>
                                <option>×‘×’×“×™× ×œ×‘×Ÿ</option>
                                <option>×‘×’×“×™× ×œ×‘×ª</option>
                            </select>`;
                }
                container.innerHTML = html;
            }

            function renderModalItems() {
                const container = document.getElementById('items-preview-container');
                if (modalItems.length === 0) {
                    container.innerHTML = `<p class="text-center text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×¤×¨×™×˜×™× ×‘×¨×©×™××”.</p>`;
                    return;
                }
                container.innerHTML = modalItems.map((item, index) => `
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm">
                        <span>${item.text} (x${item.quantity}) - ×—×©×™×‘×•×ª ${item.priority}</span>
                        <button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-times-circle"></i></button>
                    </div>
                `).join('');
            }
            
            async function handleFinishModal() {
                const name = document.getElementById('checklist-name').value;
                if (!name) { alert('×—×•×‘×” ×œ×ª×ª ×©× ×œ×¨×©×™××”.'); return; }
                
                let type = document.getElementById('checklist-type').value;
                if (type === '××—×¨') type = document.getElementById('checklist-type-other').value;

                let destination = document.getElementById('checklist-destination')?.value || null;
                let subType = document.getElementById('checklist-subtype')?.value || null;
                if (subType === '××—×¨') subType = document.getElementById('checklist-subtype-other')?.value || null;

                const checklistData = { name, type, destination, subType, items: modalItems, updatedAt: serverTimestamp() };
                
                try {
                    if (editingChecklistId) {
                        const docRef = doc(db, 'checklists', editingChecklistId);
                        await updateDoc(docRef, checklistData);
                    } else {
                        checklistData.createdAt = serverTimestamp();
                        await addDoc(checklistsCollection, checklistData);
                    }
                    closeModal();
                } catch (e) {
                    console.error("Error saving checklist: ", e);
                    alert("××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”×¨×©×™××”.");
                }
            }
            
            // --- Event Listeners ---
            addChecklistBtn.addEventListener('click', () => openModal());
            modalCloseBtn.addEventListener('click', closeModal);
            modalBackBtn.addEventListener('click', () => { currentModalStep--; updateModalStep(); });
            modalNextBtn.addEventListener('click', () => { currentModalStep++; updateModalStep(); });
            modalFinishBtn.addEventListener('click', handleFinishModal);
            
            document.getElementById('checklist-type').addEventListener('change', (e) => {
                document.getElementById('checklist-type-other').classList.toggle('hidden', e.target.value !== '××—×¨');
                updateModalStep(); // Recalculate steps
            });

            document.getElementById('step-2').addEventListener('change', (e) => {
                 if (e.target.id === 'checklist-subtype') {
                    document.getElementById('checklist-subtype-other').classList.toggle('hidden', e.target.value !== '××—×¨');
                 }
            });

            document.getElementById('add-item-btn').addEventListener('click', () => {
                const text = document.getElementById('item-text').value;
                if (!text) return;
                modalItems.push({
                    text,
                    quantity: document.getElementById('item-quantity').value || 1,
                    description: document.getElementById('item-description').value,
                    priority: document.getElementById('item-priority').value,
                    checked: false
                });
                renderModalItems();
                // Clear inputs
                document.getElementById('item-text').value = '';
                document.getElementById('item-description').value = '';
            });

            document.getElementById('items-preview-container').addEventListener('click', (e) => {
                if (e.target.closest('.remove-item-btn')) {
                    const index = e.target.closest('.remove-item-btn').dataset.index;
                    modalItems.splice(index, 1);
                    renderModalItems();
                }
            });

            // Delegated listeners for checklist items
            checklistsContainer.addEventListener('change', async (e) => {
                if (e.target.type === 'checkbox') {
                    const listId = e.target.dataset.listId;
                    const itemIndex = parseInt(e.target.dataset.itemIndex, 10);
                    const isChecked = e.target.checked;
                    
                    const list = checklistsData.find(l => l.id === listId);
                    if (list) {
                        const updatedItems = [...list.items];
                        updatedItems[itemIndex].checked = isChecked;
                        const docRef = doc(db, 'checklists', listId);
                        await updateDoc(docRef, { items: updatedItems });
                    }
                }
            });

            checklistsContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const listId = deleteBtn.dataset.listId;
                    const list = checklistsData.find(l => l.id === listId);
                    deleteModal.classList.remove('hidden');
                    deleteModal.classList.add('flex');
                    
                    let confirmationStep = 1;
                    deleteModalConfirm.textContent = '××—×§';
                    deleteModalTitle.textContent = `×”×× ×œ××—×•×§ ××ª "${list.name}"?`;
                    
                    const confirmHandler = async () => {
                        if (confirmationStep === 1) {
                            deleteModalConfirm.textContent = '×œ×—×¥ ×©×•×‘ ×œ××—×™×§×” ×¡×•×¤×™×ª';
                            deleteModalConfirm.classList.replace('bg-red-500', 'bg-red-700');
                            confirmationStep = 2;
                        } else {
                            await deleteDoc(doc(db, 'checklists', listId));
                            closeDeleteModal();
                        }
                    };
                    
                    const closeDeleteModal = () => {
                        deleteModal.classList.add('hidden');
                        deleteModal.classList.remove('flex');
                        deleteModalConfirm.removeEventListener('click', confirmHandler);
                    };

                    deleteModalConfirm.addEventListener('click', confirmHandler, { once: true });
                    deleteModalCancel.addEventListener('click', closeDeleteModal, { once: true });
                }

                const editBtn = e.target.closest('.edit-btn');
                if(editBtn) {
                    const listId = editBtn.dataset.listId;
                    const listToEdit = checklistsData.find(l => l.id === listId);
                    if (listToEdit) openModal(listToEdit);
                }
            });

            // --- Utility Functions ---
            function groupBy(array, key) {
                return array.reduce((result, currentValue) => {
                    (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);
                    return result;
                }, {});
            }

            // --- Authentication Check ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    // --- User is Logged In ---
                    const displayName = user.displayName || user.email.split('@')[0];
                    authContainer.innerHTML = `
                        <span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName}</span>
                        <button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
                    
                    document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));

                    buildMenu();
                    hamburgerBtn.addEventListener('click', toggleSidebar);
                    closeSidebarBtn.addEventListener('click', toggleSidebar);
                    overlay.addEventListener('click', toggleSidebar);

                    // Subscribe to checklist changes
                    onSnapshot(checklistsCollection, (snapshot) => {
                        checklistsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderChecklists();
                        loader.style.display = 'none';
                        mainContent.classList.add('loaded');
                    });

                } else {
                    window.location.replace('login.html');
                }
            });

             function buildMenu() {
                mainMenu.innerHTML = '';
                siteData.menu.forEach(destination => {
                    const destinationDiv = document.createElement('div');
                    const button = document.createElement('button');
                    button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                    button.innerHTML = `<span>${destination.title}</span> <i class="fas fa-chevron-down chevron-icon"></i>`;
                    const submenu = document.createElement('div');
                    submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
                    destination.days.forEach(day => {
                        const dayLink = document.createElement('a');
                        dayLink.href = `${destination.page}#${day.id}`;
                        dayLink.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md transition-colors';
                        dayLink.textContent = `${destination.title.split(' ')[1]} ${day.label} ${destination.emoji}`;
                        submenu.appendChild(dayLink);
                    });
                    button.addEventListener('click', () => { submenu.classList.toggle('open'); button.querySelector('i').classList.toggle('rotate-180'); });
                    destinationDiv.appendChild(button);
                    destinationDiv.appendChild(submenu);
                    mainMenu.appendChild(destinationDiv);
                });
            }
        });
    </script>
</body>
</html>