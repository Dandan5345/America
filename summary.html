<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מנהל לוגיסטיקה לטיול ✈️🏨🚗</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Litepicker CSS for Date Range -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>

    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal-step { display: none; animation: fadeIn 0.5s; }
        .modal-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar for modal content */
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Leaflet Map Height */
        #map-container { height: 300px; border-radius: 0.5rem; }
        .leaflet-container { z-index: 10; }
        
        /* Ensure Litepicker is on top of the modal */
        .litepicker { z-index: 100 !important; }

        /* Small tag style for seat numbers */
        .seat-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .seat-tag button {
            margin-right: 6px;
            color: #38bdf8;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .seat-tag button:hover {
            color: #0ea5e9;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                 <h1 class="text-xl font-bold text-slate-800">ניהול לוגיסטיקת הטיול</h1>
                 <button id="open-add-modal-btn" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-2 px-5 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>הוספת פריט
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto space-y-12">
            
            <!-- Hotels Section -->
            <section id="hotel-section">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3"><i class="fas fa-hotel text-blue-500"></i>מלונות</h2>
                <div id="hotel-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="no-hotels-msg" class="text-slate-500 col-span-full">עדיין לא נוספו מלונות. לחצו על 'הוספת פריט' כדי להתחיל.</p>
                </div>
            </section>

            <!-- Transfers Section -->
            <section id="transport-section">
                <h2 class="text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3"><i class="fas fa-route text-green-500"></i>מעברים</h2>
                <div id="transport-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     <p id="no-transport-msg" class="text-slate-500 col-span-full">עדיין לא נוספו מעברים. לחצו על 'הוספת פריט' כדי להתחיל.</p>
                </div>
            </section>

        </div>
    </main>
    
    <!-- Add/Edit Modal -->
    <div id="item-modal" class="modal fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">הוספת פריט חדש</h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="modal-body" class="flex-grow overflow-y-auto p-6 space-y-6">
                <!-- Form steps will be injected here by JS -->
            </div>
            <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
                <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg bg-slate-200 hover:bg-slate-300 transition font-semibold hidden">אחורה</button>
                <div id="modal-error-message" class="text-red-500 text-sm font-bold h-5 text-center flex-grow"></div>
                <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">הבא</button>
                <button type="button" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">שמור פריט</button>
            </div>
        </div>
    </div>

    <!-- Details Viewer Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="details-modal-title" class="text-2xl font-bold text-slate-800">פרטי מעבר</h3>
                <button id="details-modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="details-modal-body" class="flex-grow overflow-y-auto p-6 text-slate-700 space-y-4">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Litepicker JS for Date Range -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <script type="module">
        // --- CONFIGURATION ---
        const DESTINATIONS = ['ניו יורק', 'מפלי הניאגרה', 'טורונטו', 'וושינגטון די סי', 'אורלנדו', 'מיאמי', 'מיאמי ביץ\'', 'פונטה קאנה', 'אריזונה', 'לוס אנג\'לס', 'סן פרנסיסקו'];
        const FLIGHT_DESTINATIONS = ['תל אביב', ...DESTINATIONS];

        // --- DOM ELEMENTS ---
        const DOM = {
            openModalBtn: document.getElementById('open-add-modal-btn'),
            modal: document.getElementById('item-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalBackBtn: document.getElementById('modal-back-btn'),
            modalNextBtn: document.getElementById('modal-next-btn'),
            modalFinishBtn: document.getElementById('modal-finish-btn'),
            modalError: document.getElementById('modal-error-message'),
            hotelContainer: document.getElementById('hotel-cards-container'),
            transportContainer: document.getElementById('transport-cards-container'),
            noHotelsMsg: document.getElementById('no-hotels-msg'),
            noTransportMsg: document.getElementById('no-transport-msg'),
            detailsModal: document.getElementById('details-modal'),
            detailsModalTitle: document.getElementById('details-modal-title'),
            detailsModalBody: document.getElementById('details-modal-body'),
            detailsModalCloseBtn: document.getElementById('details-modal-close-btn'),
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            modalOpen: false,
            currentStep: 0,
            itemType: null, // 'hotel', 'car', 'flight'
            formData: {},
            map: null,
            mapMarkers: [],
            mapPolyline: null,
            datePicker: null,
            hotels: [],
            transports: [],
        };

        // --- MAP UTILITY ---
        const MapUtil = {
            init(containerId) {
                if (appState.map) {
                    appState.map.remove();
                }
                appState.map = L.map(containerId).setView([31.7683, 35.2137], 2); // Default view
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(appState.map);
            },
            clear() {
                appState.mapMarkers.forEach(marker => marker.remove());
                appState.mapMarkers = [];
                if (appState.mapPolyline) {
                    appState.mapPolyline.remove();
                    appState.mapPolyline = null;
                }
            },
            async findAddress(addressQuery) {
                this.clear();
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressQuery)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    const coords = [parseFloat(lat), parseFloat(lon)];
                    const marker = L.marker(coords).addTo(appState.map);
                    appState.mapMarkers.push(marker);
                    appState.map.setView(coords, 13);
                    return { found: true, lat: lat, lon: lon, displayName: data[0].display_name };
                }
                return { found: false };
            },
            async plotRoute(locations) {
                this.clear();
                const latlngs = [];
                for (const loc of locations) {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc.address)}&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        const coords = [parseFloat(lat), parseFloat(lon)];
                        latlngs.push(coords);
                        const marker = L.marker(coords).addTo(appState.map).bindPopup(`<b>${loc.label}</b><br>${data[0].display_name}`);
                        appState.mapMarkers.push(marker);
                    }
                }
                if (latlngs.length > 1) {
                    appState.mapPolyline = L.polyline(latlngs, { color: 'blue' }).addTo(appState.map);
                    appState.map.fitBounds(appState.mapPolyline.getBounds().pad(0.2));
                } else if (latlngs.length === 1) {
                    appState.map.setView(latlngs[0], 10);
                }
            }
        };

        // --- MODAL FORM DEFINITIONS ---
        // A structured way to define each step of the form
        const formSteps = {
            start: {
                title: 'הוספת פריט חדש',
                render: () => `
                    <label class="block text-lg font-bold text-slate-700 mb-3">איזה פריט ברצונך להוסיף?</label>
                    <select id="item-type-selector" class="w-full p-3 border rounded-lg bg-white">
                        <option value="" disabled selected>-- בחר סוג --</option>
                        <option value="hotel">🏨 מלון</option>
                        <option value="transport">✈️ מעבר (טיסה / רכב)</option>
                    </select>`,
                process: () => {
                    const selector = document.getElementById('item-type-selector');
                    if (!selector.value) {
                        showError("יש לבחור סוג פריט.");
                        return false;
                    }
                    appState.itemType = selector.value;
                    return true;
                }
            },
            // ... other steps for hotel, transport type, car, flight
        };
        
        // This is a simplified representation. The full logic will be more complex.
        // The actual implementation below uses dynamic functions instead of a giant object.

        // --- DYNAMIC FORM STEP GENERATION ---
        
        function getStepContent(stepIndex) {
            const type = appState.itemType;
            // Step 0: Initial choice
            if (stepIndex === 0) return formSteps.start.render();

            // Step 1: Hotel vs Transport
            if (stepIndex === 1) {
                if (type === 'hotel') return getHotelStepContent(1);
                if (type === 'transport') return getTransportTypeStepContent();
            }
            
            // Subsequent steps
            if (stepIndex > 1) {
                 if (type === 'hotel') return getHotelStepContent(stepIndex);
                 if (type === 'car') return getCarStepContent(stepIndex - 1);
                 if (type === 'flight') return getFlightStepContent(stepIndex - 1);
            }
            return '<p>שלב לא ידוע.</p>';
        }

        // --- HOTEL STEPS ---
        function getHotelStepContent(hotelStep) {
            switch(hotelStep) {
                case 1: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (1/6)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">מה שם המלון?</label>
                    <input type="text" id="hotel-name" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: Moxy NYC Chelsea" value="${appState.formData.name || ''}">`;
                case 2: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (2/6)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">תאריכי שהייה</label>
                    <input type="text" id="hotel-dates" class="w-full p-3 border rounded-lg" placeholder="לחץ לבחירת תאריכים" readonly>`;
                case 3: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (3/6)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">כתובת המלון</label>
                    <div class="space-y-3">
                        <select id="hotel-dest" class="w-full p-3 border rounded-lg bg-white">
                            <option value="" disabled selected>-- בחר יעד --</option>
                            ${DESTINATIONS.map(d => `<option value="${d}" ${appState.formData.destination === d ? 'selected' : ''}>${d}</option>`).join('')}
                        </select>
                        <input type="text" id="hotel-address" class="w-full p-3 border rounded-lg" placeholder="הכנס כתובת מדויקת" value="${appState.formData.address || ''}">
                        <button type="button" id="find-address-btn" class="w-full py-2 px-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700">מצא כתובת במפה</button>
                    </div>
                    <div id="map-container" class="mt-4 w-full h-64 bg-slate-200 rounded-lg"></div>`;
                case 4: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (4/6)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">קישור לאתר המלון (בוקינג וכו')</label>
                    <input type="url" id="hotel-link" class="w-full p-3 border rounded-lg" placeholder="https://www.booking.com/hotel/..." value="${appState.formData.link || ''}">`;
                case 5: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (5/6)</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-lg font-bold text-slate-700 mb-2">האם יש מטבחון?</label>
                            <select id="hotel-kitchen" class="w-full p-3 border rounded-lg bg-white">
                                <option value="לא" ${appState.formData.kitchen === 'לא' ? 'selected' : ''}>לא</option>
                                <option value="כן" ${appState.formData.kitchen === 'כן' ? 'selected' : ''}>כן</option>
                                <option value="חלקי" ${appState.formData.kitchen === 'חלקי' ? 'selected' : ''}>חלקי</option>
                            </select>
                            <textarea id="hotel-kitchen-details" class="w-full p-3 border rounded-lg mt-2 ${appState.formData.kitchen === 'חלקי' ? '' : 'hidden'}" placeholder="פרט מה המטבחון כולל...">${appState.formData.kitchenDetails || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-lg font-bold text-slate-700 mb-2">האם יש ארוחת בוקר?</label>
                            <select id="hotel-breakfast" class="w-full p-3 border rounded-lg bg-white">
                                <option value="לא" ${appState.formData.breakfast === 'לא' ? 'selected' : ''}>לא</option>
                                <option value="כן" ${appState.formData.breakfast === 'כן' ? 'selected' : ''}>כן</option>
                                <option value="לא להסתמך" ${appState.formData.breakfast === 'לא להסתמך' ? 'selected' : ''}>לא להסתמך</option>
                                <option value="הכל כלול" ${appState.formData.breakfast === 'הכל כלול' ? 'selected' : ''}>הכל כלול</option>
                            </select>
                        </div>
                    </div>`;
                case 6: return `
                    <h4 class="text-xl font-semibold mb-4 text-blue-600">פרטי מלון (6/6)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">דרך איפה הוזמן?</label>
                    <input type="text" id="hotel-booked-via" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: Booking.com, Agoda" value="${appState.formData.bookedVia || ''}">
                    <label class="block text-lg font-bold text-slate-700 mb-2 mt-4">מחיר סופי (בש"ח)</label>
                    <input type="number" id="hotel-price" class="w-full p-3 border rounded-lg" placeholder="0" value="${appState.formData.price || ''}">`;
            }
        }
        
        // --- TRANSPORT STEPS ---
        function getTransportTypeStepContent() {
            return `
                <h4 class="text-xl font-semibold mb-4 text-green-600">סוג מעבר</h4>
                <label class="block text-lg font-bold text-slate-700 mb-3">בחר את סוג המעבר:</label>
                <select id="transport-type-selector" class="w-full p-3 border rounded-lg bg-white">
                    <option value="" disabled selected>-- בחר סוג --</option>
                    <option value="car">🚗 השכרת רכב</option>
                    <option value="flight">✈️ טיסה</option>
                </select>`;
        }

        function getCarStepContent(carStep) {
            // Placeholder for car rental steps
            switch(carStep) {
                case 1: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">השכרת רכב (1/5)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">לאיזה יעד?</label>
                    <select id="car-dest" class="w-full p-3 border rounded-lg bg-white">
                        <option value="" disabled selected>-- בחר יעד --</option>
                        ${DESTINATIONS.map(d => `<option value="${d}" ${appState.formData.destination === d ? 'selected' : ''}>${d}</option>`).join('')}
                    </select>
                     <label class="block text-lg font-bold text-slate-700 mb-2 mt-4">לאיזה תאריכים?</label>
                    <input type="text" id="car-dates" class="w-full p-3 border rounded-lg" placeholder="לחץ לבחירת תאריכים" readonly>`;
                case 2: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">השכרת רכב (2/5)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">דרך איפה הוזמן?</label>
                    <input type="text" id="car-booked-via" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: Rentalcars.com" value="${appState.formData.bookedVia || ''}">
                    <label class="block text-lg font-bold text-slate-700 mb-2 mt-4">קישור לאתר (אופציונלי)</label>
                    <input type="url" id="car-link" class="w-full p-3 border rounded-lg" placeholder="https://..." value="${appState.formData.link || ''}">`;
                case 3: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">השכרת רכב (3/5)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">סוג רכב</label>
                    <select id="car-type" class="w-full p-3 border rounded-lg bg-white">
                        <option value="דלק" ${appState.formData.carType === 'דלק' ? 'selected' : ''}>דלק</option>
                        <option value="היברידי" ${appState.formData.carType === 'היברידי' ? 'selected' : ''}>היברידי</option>
                        <option value="חשמלי" ${appState.formData.carType === 'חשמלי' ? 'selected' : ''}>חשמלי</option>
                    </select>
                    <label class="block text-lg font-bold text-slate-700 mb-2 mt-4">מאיפה לוקחים בדיוק?</label>
                    <input type="text" id="car-pickup" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: שדה תעופה JFK, קומה 2" value="${appState.formData.pickup || ''}">`;
                case 4: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">השכרת רכב (4/5)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">מחיר (בש"ח)</label>
                    <input type="number" id="car-price" class="w-full p-3 border rounded-lg" placeholder="0" value="${appState.formData.price || ''}">
                    <label class="block text-lg font-bold text-slate-700 mb-2 mt-4">פרטי ביטוח (אופציונלי)</label>
                    <textarea id="car-insurance" class="w-full p-3 border rounded-lg" placeholder="פרט על הביטוח...">${appState.formData.insurance || ''}</textarea>`;
                case 5: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">השכרת רכב (5/5)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">קישור להזמנה (אופציונלי)</label>
                    <input type="url" id="car-booking-link" class="w-full p-3 border rounded-lg" placeholder="https://..." value="${appState.formData.bookingLink || ''}">`;
            }
        }

        function getFlightStepContent(flightStep) {
            // Placeholder for flight steps
            switch(flightStep) {
                case 1: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (1/7) - מסלול</h4>
                    <div id="flight-route-container" class="space-y-4">
                        <!-- From -->
                        <div class="p-3 border rounded-lg bg-slate-50">
                            <p class="font-bold text-slate-500">מאיפה (המראה):</p>
                            <select class="flight-from-dest w-full p-2 border rounded-lg bg-white mt-1">
                                ${FLIGHT_DESTINATIONS.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                            <input type="text" class="flight-from-airport w-full p-2 border rounded-lg mt-2" placeholder="שם שדה תעופה מדויק">
                            <input type="text" class="flight-from-address w-full p-2 border rounded-lg mt-2" placeholder="כתובת מדויקת של השדה">
                        </div>
                        <!-- To -->
                        <div class="p-3 border rounded-lg bg-slate-50">
                            <p class="font-bold text-slate-500">לאיפה (נחיתה):</p>
                            <select class="flight-to-dest w-full p-2 border rounded-lg bg-white mt-1">
                                ${FLIGHT_DESTINATIONS.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                            <input type="text" class="flight-to-airport w-full p-2 border rounded-lg mt-2" placeholder="שם שדה תעופה מדויק">
                            <input type="text" class="flight-to-address w-full p-2 border rounded-lg mt-2" placeholder="כתובת מדויקת של השדה">
                        </div>
                    </div>
                    <button type="button" id="add-connection-btn" class="mt-3 py-2 px-4 text-sm bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200"><i class="fas fa-plus mr-1"></i> הוסף קונקשן</button>
                    <button type="button" id="find-route-btn" class="mt-4 w-full py-2 px-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700">מצא מסלול במפה</button>
                    <div id="map-container" class="mt-4 w-full h-64 bg-slate-200 rounded-lg"></div>`;
                case 2: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (2/7)</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">חברת תעופה</label>
                    <input type="text" id="flight-airline" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: El Al" value="${appState.formData.airline || ''}">`;
                case 3: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (3/7) - פרטי כבודה (לנוסע)</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="font-semibold">תיקי יד</label>
                            <input type="number" id="flight-carryon" class="w-full p-2 border rounded-lg" value="${appState.formData.carryOn || 1}">
                        </div>
                        <div>
                            <label class="font-semibold">טרולי</label>
                            <div class="flex gap-2">
                                <input type="number" id="flight-trolley-count" class="w-1/2 p-2 border rounded-lg" placeholder="כמות" value="${appState.formData.trolleyCount || 1}">
                                <input type="number" id="flight-trolley-weight" class="w-1/2 p-2 border rounded-lg" placeholder="משקל (ק'ג)" value="${appState.formData.trolleyWeight || 10}">
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold">מזוודות</label>
                            <div class="flex gap-2">
                                <input type="number" id="flight-suitcase-count" class="w-1/2 p-2 border rounded-lg" placeholder="כמות" value="${appState.formData.suitcaseCount || 1}">
                                <input type="number" id="flight-suitcase-weight" class="w-1/2 p-2 border rounded-lg" placeholder="משקל (ק'ג)" value="${appState.formData.suitcaseWeight || 20}">
                            </div>
                        </div>
                    </div>`;
                case 4: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (4/7) - מקומות ישיבה</h4>
                    <div class="flex items-center gap-2">
                        <input type="text" id="flight-seat-input" class="flex-grow p-2 border rounded-lg" placeholder="לדוגמה: 40A">
                        <button type="button" id="add-seat-btn" class="py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="seats-container" class="mt-3 flex flex-wrap gap-2">
                        ${(appState.formData.seats || []).map(seat => `<span class="seat-tag">${seat}<button class="remove-seat-btn" data-seat="${seat}">&times;</button></span>`).join('')}
                    </div>`;
                case 5: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (5/7) - זמנים</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">זמן טיסה כולל (כולל קונקשנים)</label>
                    <input type="text" id="flight-duration" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: 11 שעות ו-30 דקות" value="${appState.formData.duration || ''}">`;
                case 6: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (6/7) - שעות</h4>
                    <div id="flight-times-container" class="space-y-4">
                        <!-- Filled dynamically based on route -->
                    </div>`;
                case 7: return `
                    <h4 class="text-xl font-semibold mb-4 text-green-600">טיסה (7/7) - מחיר</h4>
                    <label class="block text-lg font-bold text-slate-700 mb-2">מחיר הטיסה הכולל (לאדם)</label>
                    <input type="number" id="flight-price" class="w-full p-3 border rounded-lg" placeholder="0" value="${appState.formData.price || ''}">`;
            }
        }
        
        // --- MODAL CONTROL LOGIC ---
        function openModal() {
            appState.modalOpen = true;
            appState.currentStep = 0;
            appState.itemType = null;
            appState.formData = {};
            DOM.modal.classList.remove('hidden');
            renderCurrentStep();
            setTimeout(() => {
                DOM.modal.classList.remove('opacity-0');
                DOM.modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            appState.modalOpen = false;
            DOM.modal.classList.add('opacity-0');
            DOM.modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => DOM.modal.classList.add('hidden'), 300);
            if (appState.datePicker) {
                appState.datePicker.destroy();
                appState.datePicker = null;
            }
        }

        function nextStep() {
            if (!processCurrentStep()) return;
            
            const totalSteps = getTotalSteps();
            if (appState.currentStep < totalSteps - 1) {
                appState.currentStep++;
                renderCurrentStep();
            }
        }

        function prevStep() {
            if (appState.currentStep > 0) {
                appState.currentStep--;
                // If going back from step 2 to 1, reset item type choice
                if (appState.currentStep === 0) {
                    appState.itemType = null;
                }
                 // If going back from car/flight to transport type selection
                if ((appState.itemType === 'car' || appState.itemType === 'flight') && appState.currentStep === 1) {
                    appState.itemType = 'transport';
                }
                renderCurrentStep();
            }
        }

        function renderCurrentStep() {
            DOM.modalBody.innerHTML = getStepContent(appState.currentStep);
            DOM.modalTitle.textContent = getStepTitle();
            updateModalButtons();
            runStepSpecificJS();
        }
        
        function runStepSpecificJS() {
            // This function runs JS needed for the current step, like initializing maps or datepickers
            clearError();
            // Hotel Date Picker
            if (appState.itemType === 'hotel' && appState.currentStep === 2) {
                appState.datePicker = new Litepicker({ 
                    element: document.getElementById('hotel-dates'),
                    singleMode: false,
                    format: 'DD/MM/YYYY',
                });
                if(appState.formData.dates) {
                    const [start, end] = appState.formData.dates.split(' - ');
                    appState.datePicker.setDateRange(new Date(start.split('/').reverse().join('-')), new Date(end.split('/').reverse().join('-')));
                }
            }
            // Car Date Picker
            if (appState.itemType === 'car' && appState.currentStep === 2) {
                 appState.datePicker = new Litepicker({ 
                    element: document.getElementById('car-dates'),
                    singleMode: false,
                    format: 'DD/MM/YYYY',
                });
                if(appState.formData.dates) {
                    const [start, end] = appState.formData.dates.split(' - ');
                    appState.datePicker.setDateRange(new Date(start.split('/').reverse().join('-')), new Date(end.split('/').reverse().join('-')));
                }
            }
            // Hotel Map
            if (appState.itemType === 'hotel' && appState.currentStep === 3) {
                MapUtil.init('map-container');
                document.getElementById('find-address-btn').addEventListener('click', async () => {
                    const addressInput = document.getElementById('hotel-address');
                    if (!addressInput.value) {
                        showError("יש להזין כתובת לחיפוש.");
                        return;
                    }
                    showError("מחפש כתובת...");
                    const result = await MapUtil.findAddress(addressInput.value);
                    if (result.found) {
                        appState.formData.mapLocation = { lat: result.lat, lon: result.lon, name: result.displayName };
                        clearError();
                    } else {
                        showError("הכתובת לא נמצאה.");
                        delete appState.formData.mapLocation;
                    }
                });
            }
            // Flight Map
            if (appState.itemType === 'flight' && appState.currentStep === 2) {
                MapUtil.init('map-container');
                document.getElementById('find-route-btn').addEventListener('click', async () => {
                    const locations = [];
                    // From
                    const fromAddr = document.querySelector('.flight-from-address').value;
                    if(fromAddr) locations.push({ label: 'המראה', address: fromAddr });
                    // Connections
                    document.querySelectorAll('.connection-leg').forEach((conn, i) => {
                        const connAddr = conn.querySelector('.flight-conn-address').value;
                        if(connAddr) locations.push({ label: `קונקשן ${i+1}`, address: connAddr });
                    });
                    // To
                    const toAddr = document.querySelector('.flight-to-address').value;
                    if(toAddr) locations.push({ label: 'נחיתה', address: toAddr });

                    if (locations.length < 2) {
                        showError("יש להזין לפחות 2 כתובות.");
                        return;
                    }
                    showError("משרטט מסלול...");
                    await MapUtil.plotRoute(locations);
                    clearError();
                });
                document.getElementById('add-connection-btn').addEventListener('click', addConnectionLeg);
            }
            // Flight Seat Management
            if (appState.itemType === 'flight' && appState.currentStep === 5) {
                document.getElementById('add-seat-btn').addEventListener('click', () => {
                    const input = document.getElementById('flight-seat-input');
                    if (input.value) {
                        if (!appState.formData.seats) appState.formData.seats = [];
                        appState.formData.seats.push(input.value.trim());
                        input.value = '';
                        renderSeats();
                    }
                });
                document.getElementById('seats-container').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-seat-btn')) {
                        const seatToRemove = e.target.dataset.seat;
                        appState.formData.seats = appState.formData.seats.filter(s => s !== seatToRemove);
                        renderSeats();
                    }
                });
            }
            // Flight Times
            if (appState.itemType === 'flight' && appState.currentStep === 7) {
                renderFlightTimesInputs();
            }
            // Kitchen details
            if (appState.itemType === 'hotel' && appState.currentStep === 5) {
                const kitchenSelect = document.getElementById('hotel-kitchen');
                const detailsTextarea = document.getElementById('hotel-kitchen-details');
                kitchenSelect.addEventListener('change', () => {
                    detailsTextarea.classList.toggle('hidden', kitchenSelect.value !== 'חלקי');
                });
            }
        }
        
        function processCurrentStep() {
            clearError();
            const step = appState.currentStep;
            
            if (step === 0) { // Choose item type
                const selector = document.getElementById('item-type-selector');
                if (!selector.value) {
                    showError("יש לבחור סוג פריט.");
                    return false;
                }
                appState.itemType = selector.value;
                return true;
            }

            if (appState.itemType === 'transport' && step === 1) { // Choose transport type
                const selector = document.getElementById('transport-type-selector');
                if (!selector.value) {
                    showError("יש לבחור סוג מעבר.");
                    return false;
                }
                appState.itemType = selector.value; // Now becomes 'car' or 'flight'
                return true;
            }
            
            // --- Collect data from inputs for each step ---
            // This part needs to be built out for every single step and input
            // Example for Hotel Step 1:
            if (appState.itemType === 'hotel' && step === 1) {
                const name = document.getElementById('hotel-name').value;
                if (!name) { showError("שם המלון הוא שדה חובה."); return false; }
                appState.formData.name = name;
            }
            if (appState.itemType === 'hotel' && step === 2) {
                const dates = document.getElementById('hotel-dates').value;
                if (!dates) { showError("תאריכים הם שדה חובה."); return false; }
                appState.formData.dates = dates;
            }
            if (appState.itemType === 'hotel' && step === 3) {
                const dest = document.getElementById('hotel-dest').value;
                const address = document.getElementById('hotel-address').value;
                if (!dest || !address) { showError("יעד וכתובת הם שדות חובה."); return false; }
                if (!appState.formData.mapLocation) { showError("יש למצוא את הכתובת במפה."); return false; }
                appState.formData.destination = dest;
                appState.formData.address = address;
            }
            // ... and so on for all other steps and types
            
            return true; // Assume success for now
        }

        function finishForm() {
            if (!processCurrentStep()) return;
            
            // Final data collection for the last step
            const type = appState.itemType;
            if (type === 'hotel') {
                appState.formData.bookedVia = document.getElementById('hotel-booked-via').value;
                appState.formData.price = parseFloat(document.getElementById('hotel-price').value) || 0;
                appState.hotels.push({ id: Date.now(), type: 'hotel', ...appState.formData });
            } else {
                // This is a simplified example. You'd need specific logic for car/flight
                appState.formData.price = parseFloat(document.querySelector('input[type=number]').value) || 0;
                appState.transports.push({ id: Date.now(), type: type, ...appState.formData });
            }
            
            renderAllItems();
            closeModal();
        }

        // --- UI & RENDER ---
        
        function renderAllItems() {
            // Render Hotels
            if (appState.hotels.length > 0) {
                DOM.noHotelsMsg.classList.add('hidden');
                DOM.hotelContainer.innerHTML = appState.hotels.map(renderHotelCard).join('');
            } else {
                DOM.noHotelsMsg.classList.remove('hidden');
                DOM.hotelContainer.innerHTML = '';
            }
            // Render Transports
            if (appState.transports.length > 0) {
                DOM.noTransportMsg.classList.add('hidden');
                DOM.transportContainer.innerHTML = appState.transports.map(renderTransportCard).join('');
            } else {
                DOM.noTransportMsg.classList.remove('hidden');
                DOM.transportContainer.innerHTML = '';
            }
        }

        function renderHotelCard(hotel) {
            return `
            <div class="bg-white p-5 rounded-2xl shadow-lg flex flex-col">
                <div class="flex-grow">
                    <h4 class="font-bold text-lg text-slate-800">${hotel.name}</h4>
                    <p class="text-sm text-slate-500 mb-3">${hotel.destination} | ${hotel.dates}</p>
                    <ul class="space-y-2 text-slate-600 text-sm mb-4">
                        <li><i class="fa-solid fa-utensils fa-fw text-blue-500"></i> <strong>מטבחון:</strong> ${hotel.kitchen || 'לא צוין'}</li>
                        <li><i class="fa-solid fa-mug-saucer fa-fw text-blue-500"></i> <strong>א. בוקר:</strong> ${hotel.breakfast || 'לא צוין'}</li>
                        <li><i class="fa-solid fa-tag fa-fw text-green-500"></i> <strong>מחיר:</strong> ${hotel.price ? hotel.price.toLocaleString() : '0'} ₪</li>
                    </ul>
                </div>
                <div class="mt-auto grid grid-cols-2 gap-2">
                    <a href="${hotel.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${hotel.link ? '' : 'opacity-50 cursor-not-allowed'}">לאתר <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition ${hotel.address ? '' : 'opacity-50 cursor-not-allowed'}">נווט <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>
                </div>
            </div>`;
        }

        function renderTransportCard(transport) {
            let title = '', icon = '', details = '';
            if (transport.type === 'car') {
                icon = '🚗';
                title = `רכב שכור - ${transport.destination}`;
                details = `${transport.dates}`;
            }
            if (transport.type === 'flight') {
                icon = '✈️';
                const from = transport.route.from.dest;
                const to = transport.route.to.dest;
                title = `טיסה: ${from} ← ${to}`;
                details = `${transport.airline}`;
            }

            return `
            <div class="bg-white p-5 rounded-2xl shadow-lg flex flex-col">
                <div class="flex-grow">
                    <h4 class="font-bold text-lg text-slate-800">${icon} ${title}</h4>
                    <p class="text-sm text-slate-500 mb-3">${details}</p>
                    <p class="text-slate-600 text-sm mb-4">
                        <i class="fa-solid fa-tag fa-fw text-green-500"></i> <strong>מחיר:</strong> ${transport.price ? transport.price.toLocaleString() : '0'} ₪
                    </p>
                </div>
                <div class="mt-auto">
                    <button class="view-details-btn w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition" data-id="${transport.id}">
                        צפה בפרטים המלאים
                    </button>
                </div>
            </div>`;
        }

        function showDetailsModal(transportId) {
            const item = appState.transports.find(t => t.id == transportId);
            if (!item) return;
            
            let content = '';
            if (item.type === 'car') {
                DOM.detailsModalTitle.textContent = "פרטי השכרת רכב";
                content = `
                    <p><strong>יעד:</strong> ${item.destination}</p>
                    <p><strong>תאריכים:</strong> ${item.dates}</p>
                    <p><strong>הוזמן דרך:</strong> ${item.bookedVia}</p>
                    <p><strong>סוג רכב:</strong> ${item.carType}</p>
                    <p><strong>איסוף:</strong> ${item.pickup}</p>
                    <p><strong>מחיר:</strong> ${item.price.toLocaleString()} ₪</p>
                    ${item.insurance ? `<p><strong>ביטוח:</strong> ${item.insurance}</p>` : ''}
                    ${item.link ? `<p><strong>קישור:</strong> <a href="${item.link}" target="_blank" class="text-blue-600 hover:underline">פתח קישור</a></p>` : ''}
                `;
            } else if (item.type === 'flight') {
                DOM.detailsModalTitle.textContent = "פרטי טיסה";
                // This would be a more complex render function based on the flight data
                content = `<p><strong>חברת תעופה:</strong> ${item.airline}</p>
                           <p><strong>מסלול:</strong> מפורט בהמשך...</p>
                           <p><strong>מחיר לאדם:</strong> ${item.price.toLocaleString()} ₪</p>`;
            }
            
            DOM.detailsModalBody.innerHTML = content;
            DOM.detailsModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.detailsModal.classList.remove('opacity-0');
                DOM.detailsModal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        // --- HELPERS ---
        function getStepTitle() {
            if (appState.currentStep === 0) return "הוספת פריט חדש";
            if (appState.itemType === 'hotel') return "הוספת מלון";
            if (appState.itemType === 'car') return "הוספת רכב שכור";
            if (appState.itemType === 'flight') return "הוספת טיסה";
            return "הוספת פריט";
        }

        function getTotalSteps() {
            if (appState.itemType === 'hotel') return 7; // 1 (type) + 6 (hotel)
            if (appState.itemType === 'car') return 7; // 1 (type) + 1 (transport type) + 5 (car)
            if (appState.itemType === 'flight') return 9; // 1 + 1 + 7 (flight)
            if (appState.itemType === 'transport') return 2;
            return 1;
        }

        function updateModalButtons() {
            const totalSteps = getTotalSteps();
            DOM.modalBackBtn.classList.toggle('hidden', appState.currentStep === 0);
            DOM.modalNextBtn.classList.toggle('hidden', appState.currentStep >= totalSteps - 1);
            DOM.modalFinishBtn.classList.toggle('hidden', appState.currentStep < totalSteps - 1);
        }
        
        function showError(msg) { DOM.modalError.textContent = msg; }
        function clearError() { DOM.modalError.textContent = ''; }

        function addConnectionLeg() {
            const container = document.getElementById('flight-route-container');
            const connectionCount = container.querySelectorAll('.connection-leg').length + 1;
            const div = document.createElement('div');
            div.className = 'connection-leg p-3 border rounded-lg bg-sky-50 relative';
            div.innerHTML = `
                <button type="button" class="remove-connection-btn absolute top-2 left-2 text-red-500 hover:text-red-700">&times;</button>
                <p class="font-bold text-slate-500">קונקשן ${connectionCount}:</p>
                <input type="text" class="flight-conn-airport w-full p-2 border rounded-lg mt-2" placeholder="שם שדה תעופה מדויק">
                <input type="text" class="flight-conn-address w-full p-2 border rounded-lg mt-2" placeholder="כתובת מדויקת של השדה">
                <input type="text" class="flight-conn-duration w-full p-2 border rounded-lg mt-2" placeholder="כמה זמן קונקשן?">
                <div class="mt-2 text-sm">
                    <p>האם המזוודות עוברות לבד?</p>
                    <label class="mr-2"><input type="radio" name="bags-${connectionCount}" value="auto" checked> כן</label>
                    <label><input type="radio" name="bags-${connectionCount}" value="manual"> לא, צריך צ'ק-אין מחדש</label>
                </div>
            `;
            // Insert before the "To" section
            container.insertBefore(div, container.children[container.children.length - 1]);
            div.querySelector('.remove-connection-btn').addEventListener('click', () => div.remove());
        }

        function renderSeats() {
            const container = document.getElementById('seats-container');
            container.innerHTML = (appState.formData.seats || [])
                .map(seat => `<span class="seat-tag">${seat}<button type="button" class="remove-seat-btn" data-seat="${seat}">&times;</button></span>`)
                .join('');
        }

        function renderFlightTimesInputs() {
            const container = document.getElementById('flight-times-container');
            let html = '';
            const route = appState.formData.route;

            html += `
                <div class="p-2 border-l-4 border-blue-400">
                    <label class="font-semibold">המראה מ${route.from.dest}:</label>
                    <input type="datetime-local" class="w-full p-2 border rounded-lg mt-1">
                </div>
            `;

            (route.connections || []).forEach((conn, i) => {
                html += `
                <div class="p-2 border-l-4 border-sky-400">
                    <label class="font-semibold">נחיתה בקונקשן ${i+1} (${conn.airport}):</label>
                    <input type="datetime-local" class="w-full p-2 border rounded-lg mt-1">
                    <label class="font-semibold mt-2 block">המראה מקונקשן ${i+1}:</label>
                    <input type="datetime-local" class="w-full p-2 border rounded-lg mt-1">
                </div>
                `;
            });
            
            html += `
                <div class="p-2 border-l-4 border-green-400">
                    <label class="font-semibold">נחיתה ב${route.to.dest}:</label>
                    <input type="datetime-local" class="w-full p-2 border rounded-lg mt-1">
                </div>
            `;
            container.innerHTML = html;
        }

        // --- EVENT LISTENERS ---
        DOM.openModalBtn.addEventListener('click', openModal);
        DOM.modalCloseBtn.addEventListener('click', closeModal);
        DOM.modalNextBtn.addEventListener('click', nextStep);
        DOM.modalBackBtn.addEventListener('click', prevStep);
        DOM.modalFinishBtn.addEventListener('click', finishForm);
        
        // Event delegation for details buttons
        document.addEventListener('click', e => {
            const detailsBtn = e.target.closest('.view-details-btn');
            if (detailsBtn) {
                showDetailsModal(detailsBtn.dataset.id);
            }
        });
        
        DOM.detailsModalCloseBtn.addEventListener('click', () => {
             DOM.detailsModal.classList.add('opacity-0');
            DOM.detailsModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => DOM.detailsModal.classList.add('hidden'), 300);
        });

        // --- INITIAL RENDER ---
        renderAllItems();

    </script>
</body>
</html>
