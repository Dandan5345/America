<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¡×¢ ×—×œ×•××•×ª ğŸ—½ ×“×£ ×”×‘×™×ª</title>
    <link rel="manifest" href="manifest.json">
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .submenu.open { max-height: 1200px; }
        #trip-map-container { height: 450px; border-radius: 1rem; z-index: 0; }
        .leaflet-div-icon { background: transparent; border: none; font-size: 1.5rem; text-align: center; }
        
        .modal { transition: opacity 0.3s ease; }
        
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .chevron-icon { transition: transform 0.3s ease-out; }
        details[open] > summary .chevron-icon { transform: rotate(180deg); }
        
        .main-nav-button {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .main-nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        /* Loading Overlay */
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ ××ª ××¨×›×– ×”×‘×§×¨×”...</p>
    </div>

    <!-- Fixed Background -->
    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/PXLTIi4.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Scrollable Content Wrapper -->
    <div class="relative z-10">
        <!-- Navigation Modal -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 id="nav-modal-title" class="text-xl font-bold text-slate-800 mb-4">× ×•×•×˜ ××œ...</h3>
                <div id="nav-modal-content" class="flex flex-col gap-4">
                    <a id="nav-waze-link" href="#" target="_blank" class="block w-full text-center bg-[#33ccff] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#00bfff] transition text-lg"><i class="fa-brands fa-waze"></i> Waze</a>
                    <a id="nav-gmaps-link" href="#" target="_blank" class="block w-full text-center bg-[#4285F4] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3367D6] transition text-lg"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>
                </div>
                <p id="nav-modal-message" class="text-slate-600"></p>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-slate-700">×¡×’×•×¨</button>
            </div>
        </div>
        
        <!-- TopCashback Edit Modal -->
        <div id="cashback-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 class="text-xl font-bold text-slate-800 mb-4">×¢×“×›×•×Ÿ ×”×—×–×¨ TopCashback</h3>
                <div class="flex flex-col gap-4">
                    <label for="cashback-amount" class="text-slate-600">×”×–×Ÿ ××ª ×¡×›×•× ×”×”×—×–×¨ ×‘×©×§×œ×™× (×œ×“×•×’××”: -3068)</label>
                    <input type="number" id="cashback-amount" class="form-input w-full p-3 text-center text-lg font-mono border rounded-lg" placeholder="-3068">
                </div>
                <div class="mt-6 flex gap-4">
                    <button id="cashback-modal-close" class="flex-1 py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
                    <button id="cashback-modal-save" class="flex-1 py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">×©××•×¨</button>
                </div>
            </div>
        </div>


        <!-- Sidebar (Full Navigation Menu) -->
        <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
            <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢</h2>
                <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav id="main-menu" class="p-4 space-y-2"></nav>
        </aside>

        <!-- Main Content -->
        <div id="main-content" class="min-h-screen">
            <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <h1 class="text-xl font-bold text-slate-800">âœ¨ ××¡×¢ ×—×œ×•××•×ª 2025-26 âœ¨</h1>
                        <div class="flex items-center gap-4">
                            <div id="auth-container"></div>
                            <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="× ×•×•×˜ ×œ××œ×•×Ÿ"><i class="fas fa-hotel fa-lg"></i></button>
                            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">
                
                    <!-- Hero Section with New Navigation -->
                    <section class="text-center">
                        <h2 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">×”×”×¨×¤×ª×§×” ×”×’×“×•×œ×” ×©×œ× ×• ××—×•×£ ×œ×—×•×£</h2>
                        <p class="mt-4 text-lg text-slate-200 max-w-3xl mx-auto">×–×”×• ××¨×›×– ×”×‘×§×¨×” ×©×œ ×”×˜×™×•×œ! ××›××Ÿ ××¤×©×¨ ×œ× ×•×•×˜ ×œ×›×œ ×”××™×“×¢ ×”×—×©×•×‘.</p>
                        <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-4xl mx-auto">
                            <a href="checklists.html" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                                <i class="fas fa-list-check text-3xl mb-2"></i><span class="font-bold">×¨×©×™××•×ª ×•×¦'×§-×œ×™×¡×˜×™×</span>
                            </a>
                            <a href="attractions.html" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                                <i class="fas fa-map-marked-alt text-3xl mb-2"></i><span class="font-bold">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</span>
                            </a>
                            <a href="summary.html" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                                <i class="fas fa-plane-departure text-3xl mb-2"></i><span class="font-bold">×¡×™×›×•× ××œ×•× ×•×ª ×•××¢×‘×¨×™×</span>
                            </a>
                             <!-- Gemini Button - START -->
                             <div class="sm:col-span-3 mt-4">
                                <button id="gemini-nearby-btn" class="main-nav-button bg-gradient-to-r from-purple-500 to-indigo-600 w-full flex items-center justify-center gap-3 p-4 rounded-xl text-white text-center shadow-lg">
                                    <i class="fa-solid fa-wand-magic-sparkles text-2xl"></i>
                                    <span class="font-bold text-base">××” ×™×© ×œ×¢×©×•×ª ×‘×¡×‘×™×‘×” ×©×œ×™? (×©××œ ××ª Gemini)</span>
                                </button>
                            </div>
                            <!-- Gemini Button - END -->
                        </div>
                    </section>

                    <!-- Trip Map -->
                    <section>
                        <h3 class="text-3xl font-bold text-white mb-4 text-center drop-shadow-md">××¤×ª ×”××¡×¢ ×”×›×œ×œ×™×ª</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg"><div id="trip-map-container"></div></div>
                    </section>

                    <!-- Hotel Summary -->
                    <section id="hotel-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ¨ ×¡×™×›×•× ×”××œ×•× ×•×ª ×©×œ× ×•</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>
                    
                    <!-- Flight Summary -->
                    <section id="flight-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">âœˆï¸ ×¡×™×›×•× ×”×˜×™×¡×•×ª ×©×œ× ×•</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>

                    <!-- Cost Summaries -->
                    <section>
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md flex items-center justify-center gap-4">
                            <span>ğŸ“Š ×¡×™×›×•××™ ×¢×œ×•×™×•×ª</span>
                            <button id="edit-cashback-btn" class="p-2 text-white/70 hover:text-white" title="×¢×¨×•×š ×”×—×–×¨ ×›×¡×¤×™">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </h3>
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                            <table id="final-summary-table" class="w-full"></table>
                        </div>
                    </section>

                     <!-- Destination Costs -->
                     <section>
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ’¸ ×¡×™×›×•××™ ×¢×œ×•×™×•×ª ×œ×¤×™ ×™×¢×“</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                            <details id="destination-costs-summary" class="group">
                                <summary class="text-xl font-bold text-slate-700 cursor-pointer flex justify-between items-center">
                                    <span>×¤×ª×— ×¡×™×›×•××™ ×¢×œ×•×™×•×ª</span>
                                    <i class="fa-solid fa-chevron-down chevron-icon"></i>
                                </summary>
                                <div id="destination-costs-container" class="mt-6 space-y-8 border-t pt-6"></div>
                            </details>
                        </div>
                    </section>
                    
                </div>
            </main>
        </div>
        
        <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBuhPaw4P-rLeb1Xzou2COUE1O0hX3z44w",
            authDomain: "america1tour.firebaseapp.com",
            projectId: "america1tour",
            storageBucket: "america1tour.firebasestorage.app",
            messagingSenderId: "70515728009",
            appId: "1:70515728009:web:aded0696b4f72c910b7058",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const logisticsCollection = collection(db, 'logistics_v2');
        const configDocRef = doc(db, 'trip_config', 'main');

        let allLogisticsItems = [];
        let topCashbackAmountILS = -3068; // Default value

        const siteData = {
            menu: [
                { id: 'israel', page: 'israel.html', title: 'ğŸ‡®ğŸ‡± ×™×•× ×”×™×¦×™××”', emoji: 'ğŸ‡®ğŸ‡±', days: [ { id: 'day-22-12', label: '22/12' } ] },
                { id: 'new-york', page: 'new-york.html', title: 'ğŸ—½ × ×™×•-×™×•×¨×§', emoji: 'ğŸ—½', days: [
                    { id: 'day-23-12', label: '23/12' }, { id: 'day-24-12', label: '24/12' }, { id: 'day-25-12', label: '25/12' }, { id: 'day-26-12', label: '26/12' }, { id: 'day-27-12', label: '27/12' }, { id: 'day-28-12', label: '28/12' }, { id: 'day-29-12', label: '29/12' }, { id: 'day-30-12', label: '30/12' }, { id: 'day-31-12', label: '31/12' }, { id: 'day-01-01', label: '01/01' }
                ]},
                { id: 'niagara', page: 'niagara.html', title: 'â„ï¸ ×§× ×“×”', emoji: 'ğŸ‡¨ğŸ‡¦', days: [ { id: 'day-01-01', label: '01/01' }, { id: 'day-02-01', label: '02/01' }, { id: 'day-03-01', label: '03/01' }, { id: 'day-04-01', label: '04/01' } ]},
                { id: 'dc', page: 'dc.html', title: 'ğŸ›ï¸ ×•×•×©×™× ×’×˜×•×Ÿ ×“×™.×¡×™', emoji: 'ğŸ›ï¸', days: [ { id: 'day-04-01', label: '04/01' }, { id: 'day-05-01', label: '05/01' }, { id: 'day-06-01', label: '06/01' }, { id: 'day-07-01', label: '07/01' } ]},
                { id: 'orlando', page: 'orlando.html', title: 'ğŸ¢ ××•×¨×œ× ×“×•', emoji: 'ğŸ¢', days: [ { id: 'day-07-01', label: '07/01' }, { id: 'day-08-01', label: '08/01' }, { id: 'day-09-01', label: '09/01' }, { id: 'day-10-01', label: '10/01' }, { id: 'day-11-01', label: '11/01' }, { id: 'day-12-01', label: '12/01' } ]},
                { id: 'miami', page: 'miami.html', title: 'ğŸŒ´ ××™×××™', emoji: 'ğŸŒ´', days: [ { id: 'day-12-01', label: '12/01' }, { id: 'day-13-01', label: '13/01' }, { id: 'day-14-01', label: '14/01' }, { id: 'day-15-01', label: '15/01' }, { id: 'day-16-01', label: '16/01' }, { id: 'day-17-01', label: '17/01' }, { id: 'day-18-01', label: '18/01' } ]},
                { id: 'punta-cana', page: 'punta-cana.html', title: 'ğŸ¹ ×¤×•× ×˜×”-×§×× ×”', emoji: 'ğŸ¹', days: [ { id: 'day-18-01', label: '18/01' }, { id: 'day-19-01', label: '19/01' }, { id: 'day-20-01', label: '20/01' }, { id: 'day-21-01', label: '21/01' }, { id: 'day-22-01', label: '22/01' } ]},
                { id: 'arizona', page: 'arizona.html', title: 'ğŸœï¸ ××¨×™×–×•× ×”', emoji: 'ğŸœï¸', days: [ { id: 'day-22-01', label: '22/01' }, { id: 'day-23-01', label: '23/01' }, { id: 'day-24-01', label: '24/01' }, { id: 'day-25-01', label: '25/01' }, { id: 'day-26-01', label: '26/01' }, { id: 'day-27-01', label: '27/01' } ]},
                { id: 'la', page: 'la.html', title: 'ğŸ¬ ×œ×•×¡ ×× ×’\'×œ×¡', emoji: 'ğŸ¬', days: [ { id: 'day-27-01', label: '27/01' }, { id: 'day-28-01', label: '28/01' }, { id: 'day-29-01', label: '29/01' }, { id: 'day-30-01', label: '30/01' }, { id: 'day-31-01', label: '31/01' }, { id: 'day-01-02', label: '01/02' } ]},
                { id: 'sf', page: 'sf.html', title: 'ğŸŒ‰ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•', emoji: 'ğŸŒ‰', days: [ { id: 'day-01-02', label: '01/02' }, { id: 'day-02-02', label: '02/02' }, { id: 'day-03-02', label: '03/02' }, { id: 'day-04-02', label: '04/02' }, { id: 'day-05-02', label: '05/02' } ]},
            ],
            locations: {
                jerusalem: { coords: [31.77, 35.21], name: "×™×¨×•×©×œ×™×" }, nyc: { coords: [40.71, -74.00], name: "× ×™×• ×™×•×¨×§" }, niagara: { coords: [43.08, -79.07], name: "× ×™××’×¨×”" }, toronto: { coords: [43.65, -79.38], name: "×˜×•×¨×•× ×˜×•" }, dc: { coords: [38.90, -77.03], name: "×•×•×©×™× ×’×˜×•×Ÿ" }, orlando: { coords: [28.53, -81.37], name: "××•×¨×œ× ×“×•" }, miami: { coords: [25.76, -80.19], name: "××™×××™" }, puntaCana: { coords: [18.58, -68.40], name: "×¤×•× ×˜×” ×§×× ×”" }, arizona: { coords: [33.44, -112.07], name: "××¨×™×–×•× ×”" }, la: { coords: [34.05, -118.24], name: "×œ×•×¡ ×× ×’'×œ×¡" }, sf: { coords: [37.77, -122.41], name: "×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•" }
            },
            destinationCosts: [
                {
                    title: 'â„ï¸ğŸ‡¨ğŸ‡¦ ×§× ×“×”: 4 ×™××™× ×‘× ×™××’×¨×” ×•×˜×•×¨×•× ×˜×•',
                    currency: 'CAD',
                    items: [
                        { category: '×™×•× 1: ×”×’×¢×” ×œ× ×™××’×¨×”', cost: 97, cost_ils: 262 },
                        { category: '×™×•× 2: ×©×™×©×™ ×‘× ×™××’×¨×”', cost: 134, cost_ils: 364 },
                        { category: '×™×•× 3: ×©×‘×ª ×•××¢×‘×¨ ×œ×˜×•×¨×•× ×˜×•', cost: 158, cost_ils: 428 },
                        { category: '×™×•× 4: ×™×•× ××—×¨×•×Ÿ ×‘×˜×•×¨×•× ×˜×•', cost: 38, cost_ils: 103 }
                    ],
                    total: { category: '×¡×”"×› ×œ××“× (4 ×™××™×)', cost: 427, cost_ils: 1157 }
                }
            ]
        };

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const overlay = document.getElementById('overlay');
        const mainMenu = document.getElementById('main-menu');
        const navModal = document.getElementById('nav-modal');
        const navModalClose = document.getElementById('nav-modal-close');
        const navigateHotelBtn = document.getElementById('navigate-hotel-btn');
        const cashbackModal = document.getElementById('cashback-modal');
        const editCashbackBtn = document.getElementById('edit-cashback-btn');
        const cashbackModalClose = document.getElementById('cashback-modal-close');
        const cashbackModalSave = document.getElementById('cashback-modal-save');
        const cashbackAmountInput = document.getElementById('cashback-amount');
        const geminiNearbyBtn = document.getElementById('gemini-nearby-btn'); // Gemini Button

        // --- Functions ---
        function toggleSidebar() { sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }
        
        function openNavModal(title, address, message) {
            document.getElementById('nav-modal-title').textContent = title;
            const navContent = document.getElementById('nav-modal-content');
            const navMessage = document.getElementById('nav-modal-message');
            const wazeLink = document.getElementById('nav-waze-link');
            const gmapsLink = document.getElementById('nav-gmaps-link');

            if (address) {
                const encodedAddress = encodeURIComponent(address);
                wazeLink.href = `https://waze.com/ul?q=${encodedAddress}`;
                gmapsLink.href = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                navContent.classList.remove('hidden');
                navMessage.classList.add('hidden');
            } else {
                navContent.classList.add('hidden');
                navMessage.textContent = message || "×¤×¨×˜×™ ×”× ×™×•×•×˜ ×¢×‘×•×¨ ××œ×•×Ÿ ×–×” ×¢×“×™×™×Ÿ ×œ× ×–××™× ×™×.";
                navMessage.classList.remove('hidden');
            }
            navModal.classList.remove('hidden');
            setTimeout(() => navModal.classList.remove('opacity-0'), 10);
        }

        function closeNavModal() { navModal.classList.add('opacity-0'); setTimeout(() => navModal.classList.add('hidden'), 300); }

        function openCashbackModal() {
            cashbackAmountInput.value = topCashbackAmountILS;
            cashbackModal.classList.remove('hidden');
            setTimeout(() => cashbackModal.classList.remove('opacity-0'), 10);
        }

        function closeCashbackModal() { cashbackModal.classList.add('opacity-0'); setTimeout(() => cashbackModal.classList.add('hidden'), 300); }

        async function saveCashback() {
            const newAmount = parseFloat(cashbackAmountInput.value);
            if (!isNaN(newAmount)) {
                try {
                    await setDoc(configDocRef, { topCashbackAmount: newAmount }, { merge: true });
                    closeCashbackModal();
                } catch (error) {
                    console.error("Error saving cashback amount:", error);
                    alert("×©×’×™××” ×‘×©××™×¨×ª ×”×¡×›×•×.");
                }
            } else {
                alert("×× × ×”×–×Ÿ ××¡×¤×¨ ×ª×§×™×Ÿ.");
            }
        }
        
        /**
         * REVISED function to handle the Gemini recommendations button click.
         */
        function handleGeminiNearbyClick() {
            const button = geminiNearbyBtn;
            const originalContent = button.innerHTML;

            if (!navigator.geolocation) {
                alert("×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.");
                return;
            }

            button.disabled = true;
            button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> <span class="font-bold">×××ª×™×Ÿ ×œ××™×©×•×¨ ××™×§×•×...</span>`;

            // 1. Open a new window immediately. It will be blank for a moment.
            const geminiWindow = window.open('', '_blank');
            if (!geminiWindow) {
                alert("× ×¨××” ×©×”×“×¤×“×¤×Ÿ ×©×œ×š ×—×¡× ×—×œ×•×Ÿ ×§×•×¤×¥. ×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ×¢×‘×•×¨ ××ª×¨ ×–×” ×•× ×¡×” ×©×•×‘.");
                button.disabled = false;
                button.innerHTML = originalContent;
                return;
            }
            geminiWindow.document.write('×˜×•×¢×Ÿ ×”××œ×¦×•×ª ×-Gemini...');

            // 2. Request the location
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 3. On success, build the URL and redirect the new window
                    const { latitude, longitude } = position.coords;
                    
                    const prompt = `You are a friendly and expert travel guide.
My current and exact location is: latitude ${latitude}, longitude ${longitude}.

Please provide a detailed list of the most recommended and worthwhile attractions within a 3-kilometer radius of my location.

For each attraction, please include the following details in Hebrew:
1.  The name of the attraction.
2.  The approximate distance from my current location (e.g., "about 1.2 km away").
3.  A detailed description of what it is and what there is to do there.
4.  The opening hours, if available.`;

                    const encodedPrompt = encodeURIComponent(prompt);
                    const geminiUrl = `https://gemini.google.com/prompt/${encodedPrompt}`;
                    
                    geminiWindow.location.href = geminiUrl;
                    
                    button.disabled = false;
                    button.innerHTML = originalContent;
                },
                (error) => {
                    // 4. On error, close the new window and show an error
                    console.error("Geolocation error:", error);
                    alert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ×”××™×§×•×. ×× × ×•×“× ×©××™×©×¨×ª ××ª ×”×‘×§×©×” ×‘×“×¤×“×¤×Ÿ ×•× ×¡×” ×©×•×‘.");
                    
                    geminiWindow.close();

                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            );
        }

        function parseStartDateString(dateString) {
            if (!dateString) return null;
            const datePart = dateString.split(' - ')[0]; 
            const [day, month, year] = datePart.split('/').map(Number);
            if (!day || !month || !year) return null;
            return new Date(year, month - 1, day);
        }

        function parseDateRange(dateString) {
            if (!dateString || !dateString.includes(' - ')) return { start: null, end: null };
            const parts = dateString.split(' - ');
            const [startDay, startMonth, startYear] = parts[0].split('/').map(Number);
            const [endDay, endMonth, endYear] = parts[1].split('/').map(Number);

            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            endDate.setHours(23, 59, 59, 999);
            return { start: startDate, end: endDate };
        }

        function navigateToCurrentHotel(hotels) {
            const today = new Date();
            let targetHotel = null;

            for (const hotel of hotels) {
                const range = parseDateRange(hotel.dates);
                if (range.start && range.end && today >= range.start && today <= range.end) {
                    targetHotel = hotel;
                    break;
                }
            }
            
            if (!targetHotel) {
                const upcomingHotels = hotels
                    .map(hotel => ({ hotel, range: parseDateRange(hotel.dates) }))
                    .filter(item => item.range.start && item.range.start > today)
                    .sort((a, b) => a.range.start - b.range.start);

                if (upcomingHotels.length > 0) {
                    targetHotel = upcomingHotels[0].hotel;
                }
            }

            if (targetHotel) {
                openNavModal(`× ×•×•×˜ ××œ: ${targetHotel.name}`, targetHotel.address);
            } else {
                openNavModal('×”××¡×¢ ×”×¡×ª×™×™×', null, '××§×•×•×™× ×©× ×”× ×™×ª×, ×”×˜×™×•×œ ×”×’×™×¢ ×œ×¡×™×•××•!');
            }
        }

        function buildMenu() {
            siteData.menu.forEach(destination => {
                const destinationDiv = document.createElement('div');
                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                button.innerHTML = `<span>${destination.title}</span> <i class="fas fa-chevron-down chevron-icon"></i>`;
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
                destination.days.forEach(day => {
                    const dayLink = document.createElement('a');
                    dayLink.href = `${destination.page}#${day.id}`;
                    dayLink.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md transition-colors';
                    dayLink.textContent = `${destination.title.split(' ')[1]} ${day.label} ${destination.emoji}`;
                    submenu.appendChild(dayLink);
                });
                button.addEventListener('click', () => { submenu.classList.toggle('open'); button.querySelector('i').classList.toggle('rotate-180'); });
                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                mainMenu.appendChild(destinationDiv);
            });
        }
        
        function buildHotelCards(hotels) {
            const container = document.querySelector('#hotel-summary-section .grid');
            if (!container) return;
            container.innerHTML = '';
            hotels.forEach(hotel => {
                let kitchenIcon = '', breakfastIcon = '';
                if (hotel.kitchen === "×”×›×œ ×›×œ×•×œ") { kitchenIcon = `<li class="flex items-center gap-2"><i class="fa-solid fa-star fa-fw text-amber-500"></i> <strong>×”×›×œ ×›×œ×•×œ</strong></li>`; }
                else if (hotel.kitchenette !== null) { kitchenIcon = hotel.kitchenette ? `<li class="flex items-center gap-2"><i class="fa-solid fa-utensils fa-fw text-green-500"></i> <strong>××˜×‘×—×•×Ÿ:</strong> ×›×Ÿ</li>` : `<li class="flex items-center gap-2"><i class="fa-solid fa-utensils fa-fw text-red-500"></i> <strong>××˜×‘×—×•×Ÿ:</strong> ××™×Ÿ</li>`; }
                if (hotel.breakfast === "×”×›×œ ×›×œ×•×œ") {} 
                else if (hotel.breakfast !== null) { breakfastIcon = `<li class="flex items-center gap-2"><i class="fa-solid fa-mug-saucer fa-fw text-blue-500"></i> <strong>×. ×‘×•×§×¨:</strong> ${hotel.breakfast}</li>`; }
                
                const card = document.createElement('div');
                card.className = "bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col";
                card.innerHTML = `<h4 class="font-bold text-lg text-slate-800">${hotel.name}</h4><p class="text-sm text-slate-500 mb-3">${hotel.destination} | ${hotel.dates}</p><ul class="space-y-2 text-slate-600 text-sm mb-4">${kitchenIcon}${breakfastIcon}<li class="flex items-center gap-2"><i class="fa-solid fa-tag fa-fw text-blue-500"></i> <strong>××—×™×¨:</strong> $${(hotel.price || 0).toLocaleString()}</li></ul><div class="mt-auto pt-4 border-t grid grid-cols-2 gap-2"><a href="${hotel.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${!hotel.link ? 'opacity-50 cursor-not-allowed' : ''}">×œ××ª×¨ <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a><button data-address="${hotel.address}" data-name="${hotel.name}" class="nav-btn text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition">× ×•×•×˜ <i class="fa-solid fa-diamond-turn-right text-xs"></i></button></div>`;
                container.appendChild(card);
            });
        }

        function buildFlightCards(flights) {
            const container = document.querySelector('#flight-summary-section .grid');
            if (!container) return;
            container.innerHTML = '';
            flights.forEach(flight => {
                const card = document.createElement('a');
                card.href = `summary.html?view=${flight.id}`;
                card.className = "main-nav-button bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex items-center gap-4 text-right";
                
                const title = `×˜×™×¡×”: ${flight.from?.destination || ''} â† ${flight.to?.destination || ''}`;
                const details = `<p class="text-sm text-slate-500">${flight.airline}</p><p class="text-sm text-slate-600 font-semibold">${flight.dates || ''}</p>`;

                card.innerHTML = `
                    <i class="fas fa-plane-departure fa-2x text-sky-500"></i>
                    <div>
                        <h4 class="font-bold text-lg text-slate-800">${title}</h4>
                        ${details}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function buildCostTables() {
            const hotels = allLogisticsItems.filter(item => item.type === 'hotel');
            const flights = allLogisticsItems.filter(item => item.type === 'flight');
            const cars = allLogisticsItems.filter(item => item.type === 'car_rental');
            
            const summaryBody = document.getElementById('final-summary-table');
            if (!summaryBody) return;
            
            const USD_TO_ILS_RATE = 3.75;

            const totalHotelsUSD = hotels.reduce((sum, hotel) => sum + (hotel.price || 0), 0);
            const totalFlightsUSD = flights.reduce((sum, flight) => {
                const numSeats = flight.seats?.length || 1;
                return sum + ((flight.price_per_person || 0) * numSeats);
            }, 0);
            const totalCarsUSD = cars.reduce((sum, car) => sum + (car.price || 0), 0);

            const totalHotelsILS = totalHotelsUSD * USD_TO_ILS_RATE;
            const totalTransportILS = (totalFlightsUSD + totalCarsUSD) * USD_TO_ILS_RATE;

            const subTotal = totalHotelsILS + totalTransportILS;
            const finalTotal = subTotal + topCashbackAmountILS;
            const perPerson = Math.round(finalTotal / 2);

            summaryBody.innerHTML = `
                <tbody class="divide-y divide-slate-200 text-slate-700">
                    <tr><td class="py-3 pr-2">ğŸ¨ ×¡×”"×› ××œ×•× ×•×ª</td><td class="py-3 pl-2 text-left font-mono">${Math.round(totalHotelsILS).toLocaleString()} â‚ª</td></tr>
                    <tr><td class="py-3 pr-2">âœˆï¸ ×¡×”"×› ×ª×—×‘×•×¨×”</td><td class="py-3 pl-2 text-left font-mono">${Math.round(totalTransportILS).toLocaleString()} â‚ª</td></tr>
                    <tr class="font-semibold"><td class="py-3 pr-2">×¡×”"×› (×œ×¤× ×™ ×”×—×–×¨)</td><td class="py-3 pl-2 text-left font-mono">${Math.round(subTotal).toLocaleString()} â‚ª</td></tr>
                    <tr><td class="py-3 pr-2 text-green-600">ğŸ’¸ ×”×—×–×¨ ×›×¡×¤×™ (TopCashback)</td><td class="py-3 pl-2 text-left font-mono text-green-600">${topCashbackAmountILS.toLocaleString()} â‚ª</td></tr>
                    <tr class="text-xl font-bold bg-slate-100 rounded-lg"><td class="p-4">×¡×”"×› ×¡×•×¤×™</td><td class="p-4 text-left font-mono">${Math.round(finalTotal).toLocaleString()} â‚ª</td></tr>
                    <tr class="text-lg font-bold"><td class="pt-4 pr-2">×¢×œ×•×ª ×œ××“×</td><td class="pt-4 pl-2 text-left font-mono">~${perPerson.toLocaleString()} â‚ª</td></tr>
                </tbody>`;
        }
        
        function buildDestinationCostSummaries() {
            const container = document.getElementById('destination-costs-container');
            if (!container || !siteData.destinationCosts) return;
            container.innerHTML = '';
            siteData.destinationCosts.forEach(dest => {
                const details = document.createElement('details');
                details.className = 'group';
                details.open = true; // Open by default
                let itemsHTML = '';
                dest.items.forEach(item => { itemsHTML += `<tr class="border-b border-slate-200 last:border-b-0"><td class="py-2 px-3">${item.category}</td><td class="py-2 px-3 font-mono text-center">${item.cost}</td><td class="py-2 px-3 font-mono text-center">~${item.cost_ils}</td></tr>`; });
                details.innerHTML = `<summary class="text-lg font-semibold text-slate-700 cursor-pointer flex justify-between items-center p-3 bg-slate-50 rounded-lg"><span>${dest.title}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary><div class="mt-4 overflow-x-auto"><table class="w-full text-sm text-right"><thead class="bg-slate-100"><tr><th class="p-2 font-semibold text-right">×§×˜×’×•×¨×™×”</th><th class="p-2 font-semibold text-center">×¢×œ×•×ª (${dest.currency})</th><th class="p-2 font-semibold text-center">×¢×œ×•×ª (â‚ª)</th></tr></thead><tbody>${itemsHTML}</tbody><tfoot class="border-t-2 border-slate-300"><tr class="font-bold text-slate-800"><td class="p-2">${dest.total.category}</td><td class="p-2 font-mono text-center">~${dest.total.cost}$</td><td class="p-2 font-mono text-center">~${dest.total.cost_ils}â‚ª</td></tr></tfoot></table></div>`;
                container.appendChild(details);
            });
        }


        function buildTripMap() {
            const mapContainer = document.getElementById('trip-map-container');
            if (!mapContainer || mapContainer._leaflet_id) return;
            const tripMap = L.map('trip-map-container').setView([38, -95], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap Â© CARTO', maxZoom: 20 }).addTo(tripMap);
            const pathCoords = Object.values(siteData.locations).map(loc => loc.coords);
            Object.values(siteData.locations).forEach(loc => { L.marker(loc.coords, { icon: L.divIcon({ className: 'leaflet-div-icon', html: 'ğŸ“' }) }).addTo(tripMap).bindTooltip(loc.name, {permanent: true, direction: 'top', offset: [0, -10]}).openTooltip(); });
            L.polyline(pathCoords, { color: '#38bdf8', weight: 3, opacity: 0.7, dashArray: '5, 10' }).addTo(tripMap);
        }

        // --- Event Listeners ---
        hamburgerBtn.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        navModalClose.addEventListener('click', closeNavModal);
        editCashbackBtn.addEventListener('click', openCashbackModal);
        cashbackModalClose.addEventListener('click', closeCashbackModal);
        cashbackModalSave.addEventListener('click', saveCashback);
        geminiNearbyBtn.addEventListener('click', handleGeminiNearbyClick); // Gemini button listener
        
        document.querySelector('#hotel-summary-section').addEventListener('click', function(e) {
            const navBtn = e.target.closest('.nav-btn');
            if (navBtn) { openNavModal(`× ×•×•×˜ ××œ ${navBtn.dataset.name}`, navBtn.dataset.address); }
        });

        // --- Initial build calls ---
        buildMenu();
        buildTripMap();
        buildDestinationCostSummaries();

        // --- Auth & Data Loading ---
        let isInitialLoad = true;

        function hideLoader() {
            if (isInitialLoad && loadingOverlay) {
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
                isInitialLoad = false;
            }
        }

        onAuthStateChanged(auth, user => {
            const authContainer = document.getElementById('auth-container');
            if (user) {
                const displayName = user.displayName || '××©×ª××©';
                authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span>`;
                
                onSnapshot(query(logisticsCollection), (snapshot) => {
                    allLogisticsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const hotels = allLogisticsItems.filter(item => item.type === 'hotel').sort((a,b) => parseStartDateString(a.dates) - parseStartDateString(b.dates));
                    let flights = allLogisticsItems.filter(item => item.type === 'flight');
                    
                    flights.sort((a, b) => {
                        const dateA = parseStartDateString(a.dates);
                        const dateB = parseStartDateString(b.dates);
                        if (dateA && dateB) { return dateA - dateB; }
                        return 0; 
                    });
                    
                    buildHotelCards(hotels);
                    buildFlightCards(flights);
                    buildCostTables();
                    navigateHotelBtn.onclick = () => navigateToCurrentHotel(hotels);
                    hideLoader();
                }, (error) => {
                    console.error("Snapshot error:", error);
                    hideLoader();
                });

                onSnapshot(configDocRef, (doc) => {
                    if (doc.exists()) {
                        topCashbackAmountILS = doc.data().topCashbackAmount || -3068;
                    } else {
                        topCashbackAmountILS = -3068;
                    }
                    buildCostTables();
                });

            } else {
                authContainer.innerHTML = `<a href="login.html" class="text-sm font-semibold text-blue-600 hover:underline">×”×ª×—×‘×¨</a>`;
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    hideLoader();
                });
            }
        });
    </script>
</body>
</html>